

# MysqlæŸ¥è¯¢ä¼˜åŒ–

å¯¹äºä¸€ä¸ªSQLè¯­å¥ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å…ˆçœ‹æ˜¯ä¸æ˜¯èƒ½è½¬æ¢æˆ`JOIN`ï¼Œå†å°†`JOIN`è¿›è¡Œä¼˜åŒ–ã€‚**

ä¼˜åŒ–åˆ†ä¸ºï¼š

1. æ¡ä»¶ä¼˜åŒ–
2. è®¡ç®—å…¨è¡¨æ‰«ææˆæœ¬
3. æ‰¾å‡ºæ‰€æœ‰èƒ½ç”¨åˆ°çš„ç´¢å¼•
4. é’ˆå¯¹æ¯ä¸ªç´¢å¼•è®¡ç®—ä¸åŒçš„è®¿é—®æ–¹å¼çš„æˆæœ¬
5. é€‰å‡ºæˆæœ¬æœ€å°çš„ç´¢å¼•ä»¥åŠè®¿é—®æ–¹å¼

## å¼€å¯æŸ¥è¯¢ä¼˜åŒ–å™¨æ—¥å¿—

```sql
-- å¼€å¯
set optimizer_trace = "enabled=on"; 
-- æ‰§è¡Œsql
select * from t1 where a = 1 and b = 1;
-- æŸ¥çœ‹æ—¥å¿—
select * from information_schema.OPTIMIZER_TRACE;
-- å…³é—­
set optimizer_trace="enabled=off";
```

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ—¥å¿—ï¼š

````json
select * from t1 where a = 1 and b = 1
LIMIT 0, 1000, {
  "steps": [
    {
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "expanded_query": "/* select#1 */ select `t1`.`a` AS `a`,`t1`.`b` AS `b`,`t1`.`c` AS `c`,`t1`.`d` AS `d`,`t1`.`e` AS `e` from `t1` where ((`t1`.`a` = 1) and (`t1`.`b` = 1)) limit 0,1000"
          }
        ]
      }
    },
    {
      // ä¼˜åŒ–é˜¶æ®µ
      "join_optimization": {
        "select#": 1,
        "steps": [
          {
            // æ¡ä»¶ä¼˜åŒ–
            "condition_processing": {
              "condition": "WHERE",
              "original_condition": "((`t1`.`a` = 1) and (`t1`.`b` = 1))",
              "steps": [
                {
                  "transformation": "equality_propagation", // ç­‰å€¼ä¼ é€’
                  "resulting_condition": "(multiple equal(1, `t1`.`a`) and multiple equal(1, `t1`.`b`))"
                },
                {
                  "transformation": "constant_propagation",
                  "resulting_condition": "(multiple equal(1, `t1`.`a`) and multiple equal(1, `t1`.`b`))"
                },
                {
                  "transformation": "trivial_condition_removal",
                  "resulting_condition": "(multiple equal(1, `t1`.`a`) and multiple equal(1, `t1`.`b`))"
                }
              ]
            }
          },
          {
            "substitute_generated_columns": {
            }
          },
          {
            "table_dependencies": [
              {
                "table": "`t1`",
                "row_may_be_null": false,
                "map_bit": 0,
                "depends_on_map_bits": [
                ]
              }
            ]
          },
          {
            "ref_optimizer_key_uses": [
              {
                "table": "`t1`",
                "field": "a",
                "equals": "1",
                "null_rejecting": false
              },
              {
                "table": "`t1`",
                "field": "b",
                "equals": "1",
                "null_rejecting": false
              }
            ]
          },
          {
            "rows_estimation": [
              {
                "table": "`t1`",
                "rows": 1,
                "cost": 1,
                "table_type": "const",
                "empty": false
              }
            ]
          },
          {
            "condition_on_constant_tables": "1",
            "condition_value": true
          },
          {
            "attaching_conditions_to_tables": {
              "original_condition": "1",
              "attached_conditions_computation": [
              ],
              "attached_conditions_summary": [
              ]
            }
          },
          {
            "refine_plan": [
            ]
          }
        ]
      }
    },
    {
      "join_execution": {
        "select#": 1,
        "steps": [
        ]
      }
    }
  ]
}, 0, 0
````

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæœ‰ä¸€ä¸ª`join optimization(joinä¼˜åŒ–)`ï¼Œå› ä¸ºåœ¨mysqlé‡Œé¢joinæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œæ— è®ºä»€ä¹ˆæŸ¥è¯¢éƒ½ä¼šå°½é‡å‘joiné æ‹¢ï¼Œåœ¨è¿™ä¸ªsqlé‡Œé¢çœ‹ä¸å‡ºæ¥æ›´å¤šçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹å¦ä¸€ä¸ªsql

```sql
select * from t1, t2;
```

````json
select * from t1, t2
LIMIT 0, 1000, {
  "steps": [
    {
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "expanded_query": "/* select#1 */ select `t1`.`a` AS `a`,`t1`.`b` AS `b`,`t1`.`c` AS `c`,`t1`.`d` AS `d`,`t1`.`e` AS `e`,`t2`.`a` AS `a`,`t2`.`b` AS `b`,`t2`.`c` AS `c`,`t2`.`d` AS `d`,`t2`.`e` AS `e` from `t1` join `t2` limit 0,1000"
          }
        ]
      }
    },
    {
      "join_optimization": {
        "select#": 1,
        "steps": [
          {
            "table_dependencies": [
              {
                "table": "`t1`",
                "row_may_be_null": false,
                "map_bit": 0,
                "depends_on_map_bits": [
                ]
              },
              {
                "table": "`t2`",
                "row_may_be_null": false,
                "map_bit": 1,
                "depends_on_map_bits": [
                ]
              }
            ]
          },
          {
            "rows_estimation": [
              {
                "table": "`t1`",
                "table_scan": {
                  "rows": 8,
                  "cost": 1
                }
              },
              {
                "table": "`t2`",
                "table_scan": {
                  "rows": 8,
                  "cost": 2
                }
              }
            ]
          },
          {
            "considered_execution_plans": [
              {
                "plan_prefix": [
                ],
                "table": "`t1`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "rows_to_scan": 8,
                      "access_type": "scan",
                      "resulting_rows": 8,
                      "cost": 2.6,
                      "chosen": true
                    }
                  ]
                },
                "condition_filtering_pct": 100,
                "rows_for_plan": 8,
                "cost_for_plan": 2.6,
                "rest_of_plan": [
                  {
                    "plan_prefix": [
                      "`t1`"
                    ],
                    "table": "`t2`",
                    "best_access_path": {
                      "considered_access_paths": [
                        {
                          "rows_to_scan": 8,
                          "access_type": "scan",
                          "using_join_cache": true,
                          "buffers_needed": 1,
                          "resulting_rows": 8,
                          "cost": 14.852,
                          "chosen": true
                        }
                      ]
                    },
                    "condition_filtering_pct": 100,
                    "rows_for_plan": 64,
                    "cost_for_plan": 17.452,
                    "chosen": true
                  }
                ]
              },
              {
                "plan_prefix": [
                ],
                "table": "`t2`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "rows_to_scan": 8,
                      "access_type": "scan",
                      "resulting_rows": 8,
                      "cost": 3.6469,
                      "chosen": true
                    }
                  ]
                },
                "condition_filtering_pct": 100,
                "rows_for_plan": 8,
                "cost_for_plan": 3.6469,
                "pruned_by_heuristic": true
              }
            ]
          },
          {
            "attaching_conditions_to_tables": {
              "original_condition": null,
              "attached_conditions_computation": [
              ],
              "attached_conditions_summary": [
                {
                  "table": "`t1`",
                  "attached": null
                },
                {
                  "table": "`t2`",
                  "attached": null
                }
              ]
            }
          },
          {
            "refine_plan": [
              {
                "table": "`t1`"
              },
              {
                "table": "`t2`"
              }
            ]
          }
        ]
      }
    },
    {
      "join_execution": {
        "select#": 1,
        "steps": [
        ]
      }
    }
  ]
}, 0, 0
````

å¯ä»¥çœ‹è§mysqlæŠŠè¿™ä¸ªæŸ¥è¯¢è½¬æ¢æˆäº†`select from t1 join t2 limit 0,1000 `ï¼Œè¯å®äº†æˆ‘ä»¬ç»“è®ºã€‚

å†æ¥çœ‹ä¸‹`explain`

````sql
explain select * from t1, t2; -- ç¬›å¡å°”ç§¯
````

![](./img/15.jpg)

é€šè¿‡è¿™ä¸ªç»“æœï¼Œå¯ä»¥çœ‹å‡ºï¼Œéƒ½æ˜¯å…¨è¡¨æ‰«æï¼Œ`t1æ˜¯é©±åŠ¨è¡¨ï¼Œt2æ˜¯è¢«é©±åŠ¨è¡¨`ï¼Œä¹Ÿå°±æ˜¯å…ˆä»t1ä¸­æ‰¾å‡ºæ•°æ®ï¼Œç„¶åå†å»t2è¡¨ä¸­æ‰¾å‡ºåŒ¹é…çš„æ•°æ®ã€‚è¿™ä¸ª`explain`å…³é”®å­—ä¹Ÿèƒ½å»å¸®æˆ‘å»é€‰å–å“ªä¸ªæ˜¯é©±åŠ¨è¡¨æˆ–è€…è¢«é©±åŠ¨è¡¨ã€‚

### å¸¸é‡ä¼ é€’(`constant_propagation`)

```sql
a = 1 AND b > a
```

ä¸Šé¢è¿™ä¸ªsqlå¯ä»¥è½¬æ¢ä¸ºï¼š

````sql
a = 1 AND b > 1
````

### ç­‰å€¼ä¼ é€’(`equality_propagation`)

````sql
a = b and b = c and c = 5
````

ä¸Šé¢è¿™ä¸ªsqlå¯ä»¥è½¬æ¢ä¸ºï¼š

````sql
a = 5 and b = 5 and c = 5
````



### ç§»é™¤æ²¡ç”¨æ¡ä»¶(`trivial_condition_removal`)

```sql
a = 1 and 1 = 1
```

è½¬æ¢æˆ

```sql
a = 1
```



### åŸºäºæˆæœ¬

ä¸€ä¸ªæŸ¥è¯¢å¯ä»¥æœ‰ä¸åŒçš„æ‰§è¡Œæ–¹æ¡ˆï¼Œå¯ä»¥é€‰æ‹©æŸä¸ªç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å…¨è¡¨æ‰«æï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šé€‰æ‹©å…¶ä¸­æˆ æœ¬æœ€ä½çš„æ–¹æ¡ˆå»æ‰§è¡ŒæŸ¥è¯¢ã€‚

#### I/Oæˆæœ¬

InnoDBå­˜å‚¨å¼•æ“éƒ½æ˜¯å°†æ•°æ®å’Œç´¢å¼•éƒ½å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ï¼Œå½“æˆ‘ä»¬æƒ³æŸ¥è¯¢è¡¨ä¸­çš„è®°å½•æ—¶ï¼Œéœ€è¦å…ˆæŠŠæ•°æ®æˆ–è€…ç´¢å¼•åŠ è½½ åˆ°å†…å­˜ä¸­ç„¶åå†æ“ä½œã€‚è¿™ä¸ªä»ç£ç›˜åˆ°å†…å­˜è¿™ä¸ªåŠ è½½çš„è¿‡ç¨‹æŸè€—çš„æ—¶é—´ç§°ä¹‹ä¸ºI/Oæˆæœ¬ã€‚

#### CPUæˆæœ¬

è¯»å–ä»¥åŠæ£€æµ‹è®°å½•æ˜¯å¦æ»¡è¶³å¯¹åº”çš„æœç´¢æ¡ä»¶ã€å¯¹ç»“æœé›†è¿›è¡Œæ’åºç­‰è¿™äº›æ“ä½œæŸè€—çš„æ—¶é—´ç§°ä¹‹ä¸ºCPUæˆæœ¬ã€‚

> InnoDBå­˜å‚¨å¼•æ“è§„å®šè¯»å–ä¸€ä¸ªé¡µé¢èŠ±è´¹çš„æˆæœ¬é»˜è®¤æ˜¯1.0ï¼Œè¯»å–ä»¥åŠæ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬é»˜ è®¤æ˜¯0.2ã€‚

#### åŸºäºæˆæœ¬çš„ä¼˜åŒ–æ­¥éª¤

åœ¨ä¸€æ¡å•è¡¨æŸ¥è¯¢è¯­å¥çœŸæ­£æ‰§è¡Œä¹‹å‰ï¼ŒMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šæ‰¾å‡ºæ‰§è¡Œè¯¥è¯­å¥æ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œå¯¹æ¯”ä¹‹åæ‰¾å‡º æˆæœ¬æœ€ä½çš„æ–¹æ¡ˆï¼Œè¿™ä¸ªæˆæœ¬æœ€ä½çš„æ–¹æ¡ˆå°±æ˜¯æ‰€è°“çš„æ‰§è¡Œè®¡åˆ’ï¼Œä¹‹åæ‰ä¼šè°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ¥å£çœŸæ­£çš„æ‰§è¡ŒæŸ¥ è¯¢ã€‚

ä¸‹è¾¹æˆ‘ä»¬å°±ä»¥ä¸€ä¸ªå®ä¾‹æ¥åˆ†æä¸€ä¸‹è¿™äº›æ­¥éª¤ï¼Œå•è¡¨æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š

æˆ‘ä»¬æ¥åˆ†æï¼Œmysqlå®˜æ–¹æ¨èçš„è¡¨`employees.titles`æ¥è¿›è¡Œåˆ†æï¼Œè¿™ä¸ªè¡¨æœ‰ä¸¤ä¸ªç´¢å¼•`PRIMARY`ï¼Œ`idx_titles_to_date`ï¼Œ`PRIMARY`ç´¢å¼•æ˜¯è”åˆç´¢å¼•`(emp_no, ..... )`

```sql
select * from employees.titles where emp_no > '10101' and emp_no < '20000' and to_date
= '1991-10-10';
```

1. æ ¹æ®æœç´¢æ¡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•

   + `emp_no > '10101'`ï¼Œè¿™ä¸ªæœç´¢æ¡ä»¶å¯ä»¥ä½¿ç”¨ä¸»é”®ç´¢å¼•PRIMARYã€‚
   + `to_date = '1991-10-10'`ï¼Œè¿™ä¸ªæœç´¢æ¡ä»¶å¯ä»¥ä½¿ç”¨äºŒçº§ç´¢å¼•idx_titles_to_dateã€‚

   ç»¼ä¸Šæ‰€è¿°ï¼Œä¸Šè¾¹çš„æŸ¥è¯¢è¯­å¥å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯possible keysåªæœ‰PRIMARYå’Œidx_titles_to_dateã€‚

2. è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»·

   å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œå…¨è¡¨æ‰«æçš„æ„æ€å°±æ˜¯æŠŠèšç°‡ç´¢å¼•ä¸­çš„è®°å½•éƒ½ä¾æ¬¡å’Œç»™å®šçš„æœç´¢æ¡ä»¶åšä¸€ä¸‹æ¯”è¾ƒï¼ŒæŠŠç¬¦åˆæœç´¢æ¡ä»¶çš„è®°å½•åŠ å…¥åˆ°ç»“æœé›†ï¼Œæ‰€ä»¥éœ€è¦å°†èšç°‡ç´¢å¼•å¯¹åº”çš„é¡µé¢åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†æ£€æµ‹è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶ã€‚ç”±äºæŸ¥è¯¢æˆæœ¬=I/Oæˆæœ¬+CPUæˆæœ¬ï¼Œæ‰€ä»¥è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»·éœ€è¦ä¸¤ä¸ªä¿¡æ¯ï¼š

   1. èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°
   2. è¯¥è¡¨ä¸­çš„è®°å½•æ•°

   MySQLä¸ºæ¯ä¸ªè¡¨ç»´æŠ¤äº†ä¸€ç³»åˆ—çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œ SHOW TABLE STATUS è¯­å¥æ¥æŸ¥çœ‹è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

   ```sql
   SHOW TABLE STATUS LIKE 'titles';
   ```

   **è¿™äº›ç»Ÿè®¡æ•°æ®ï¼Œæ˜¯innoDBè‡ªå·±å¼‚æ­¥æ›´æ–°çš„ï¼Œå¦‚æœä¿®æ”¹æ•°æ®è¶…è¿‡10%å°±ä¼šè§¦å‘ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å»è§¦å‘ã€‚**

   `Rows`

   è¡¨ç¤ºè¡¨ä¸­çš„è®°å½•æ¡æ•°ã€‚å¯¹äºä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼æ˜¯å‡†ç¡®çš„ï¼Œå¯¹äºä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥ è¯´ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ã€‚

   `Data_length`

   è¡¨ç¤ºè¡¨å ç”¨çš„å­˜å‚¨ç©ºé—´å­—èŠ‚æ•°ã€‚ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼å°±æ˜¯æ•°æ®æ–‡ä»¶çš„å¤§å°ï¼Œå¯¹äºä½¿ç”¨InnoDBå­˜ å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼å°±ç›¸å½“äºèšç°‡ç´¢å¼•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è¿™æ ·è®¡ç®—è¯¥å€¼çš„å¤§å°ï¼š

   ```
   Data_length = èšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ x æ¯ä¸ªé¡µé¢çš„å¤§å°
   ```

   æˆ‘ä»¬çš„titlesä½¿ç”¨é»˜è®¤16KBçš„é¡µé¢å¤§å°ï¼Œè€Œä¸Šè¾¹æŸ¥è¯¢ç»“æœæ˜¾ç¤ºData_lengthçš„å€¼æ˜¯`20512768`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åå‘æ¥ æ¨å¯¼å‡ºèšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ï¼š

   `````
   èšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ = Data_length Ã· 16 Ã· 1024 = 20512768 Ã· 16 Ã· 1024 = 1252
   `````

   æˆ‘ä»¬ç°åœ¨å·²ç»å¾—åˆ°äº†èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°é‡ä»¥åŠè¯¥è¡¨è®°å½•æ•°çš„ä¼°è®¡å€¼ï¼Œæ‰€ä»¥å°±å¯ä»¥è®¡ç®—å…¨è¡¨æ‰«ææˆæœ¬äº†ã€‚ä½†æ˜¯ MySQLåœ¨çœŸå®è®¡ç®—æˆæœ¬æ—¶ä¼šè¿›è¡Œä¸€äº›å¾®è°ƒã€‚

   I/Oæˆæœ¬ï¼š1252 * 1 = 1252ã€‚1252æŒ‡çš„æ˜¯èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°ï¼Œ`1.0æŒ‡çš„æ˜¯åŠ è½½ä¸€ä¸ªé¡µé¢çš„æˆæœ¬å¸¸æ•°ï¼ŒinnoDBè§„å®šçš„`ã€‚

   CPUæˆæœ¬ï¼š442070 * 0.2=88414ã€‚442070æŒ‡çš„æ˜¯ç»Ÿè®¡æ•°æ®ä¸­è¡¨çš„è®°å½•æ•°ï¼Œå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œ0.2æŒ‡çš„æ˜¯è®¿é—®ä¸€æ¡è®°å½•æ‰€éœ€çš„æˆæœ¬å¸¸æ•°ã€‚

   æ€»æˆæœ¬ï¼š1252+88414 = 89666ã€‚

   è€Œè¿™ä¸ªæˆæœ¬åœ¨mysqlçš„ä¼˜åŒ–æ—¥å¿—é‡Œé¢ä¹Ÿèƒ½çœ‹åˆ°ï¼š

   ````
   
   ````

   ç»¼ä¸Šæ‰€è¿°ï¼Œå¯¹äºtitlesçš„å…¨è¡¨æ‰«ææ‰€éœ€çš„æ€»æˆæœ¬å°±æ˜¯89666

   > æˆ‘ä»¬å‰è¾¹è¯´è¿‡è¡¨ä¸­çš„è®°å½•å…¶å®éƒ½å­˜å‚¨åœ¨èšç°‡ç´¢å¼•å¯¹åº”B+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬é€šè¿‡æ ¹èŠ‚ç‚¹è·å¾—äº†æœ€å·¦è¾¹çš„å¶å­èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ²¿ç€å¶å­èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨æŠŠæ‰€æœ‰è®°å½•éƒ½æŸ¥çœ‹ä¸€éã€‚ä¹Ÿå°±æ˜¯è¯´å…¨è¡¨æ‰«æè¿™ä¸ªè¿‡ç¨‹ï¼Œå…¶å®æœ‰çš„B+æ ‘å†…èŠ‚ç‚¹æ˜¯ä¸éœ€è¦è®¿é—®çš„ï¼Œä½†æ˜¯MySQLåœ¨è®¡ç®—å…¨è¡¨æ‰«ææˆæœ¬æ—¶ç›´æ¥ä½¿ç”¨èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°ä½œä¸ºè®¡ç®—I/Oæˆæœ¬çš„ä¾æ®ï¼Œæ˜¯ä¸åŒºåˆ†å†…èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„ã€‚	

   `InnoDBé»˜è®¤æ˜¯ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥å…¨è¡¨æ‰«æï¼Œä¼šå»æ‰«æä¸»é”®ç´¢å¼•çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯B+æ ‘çš„å¶å­èŠ‚ç‚¹çš„æ•°æ®ï¼Œè€Œä¾æ®ç´¢å¼•å»è®¡ç®—æˆæœ¬çš„è¯ï¼Œä¹Ÿæ˜¯é€šè¿‡B+æ ‘å»è®¡ç®—ï¼Œä¸è¿‡æ˜¯å»å¶å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ¥è·å–`

3. è®¡ç®—`PRIMARY`ç´¢å¼•çš„æˆæœ¬ã€‚

   è®¡ç®—PRIMARYéœ€è¦å¤šå°‘æˆæœ¬çš„å…³é”®é—®é¢˜æ˜¯ï¼šéœ€è¦é¢„ä¼°é¢„ä¼°å‡ºæ ¹æ®å¯¹åº”çš„whereæ¡ä»¶åœ¨ä¸»é”®ç´¢å¼•B+æ ‘ä¸­å­˜åœ¨å¤šå°‘æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚

   **`èŒƒå›´åŒºé—´æ•°`**

   å½“æˆ‘ä»¬ä»ç´¢å¼•ä¸­æŸ¥è¯¢è®°å½•æ—¶ï¼Œä¸ç®¡æ˜¯=ã€inã€>ã€<è¿™äº›æ“ä½œéƒ½éœ€è¦ä»ç´¢å¼•ä¸­ç¡®å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸è®ºè¿™ä¸ªèŒƒå›´åŒºé—´çš„ç´¢å¼•åˆ°åº•å ç”¨äº†å¤šå°‘é¡µé¢ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ç²—æš´çš„è®¤ä¸ºè¯»å–ç´¢å¼•çš„ä¸€ä¸ªèŒƒå›´åŒºé—´çš„I/Oæˆæœ¬å’Œè¯»å–ä¸€ä¸ªé¡µé¢æ˜¯ç›¸åŒçš„ã€‚

   æœ¬ä¾‹ä¸­ä½¿ç”¨PRIMARYçš„èŒƒå›´åŒºé—´åªæœ‰ä¸€ä¸ªï¼š(10101, 20000)ï¼Œæ‰€ä»¥ç›¸å½“äºè®¿é—®è¿™ä¸ªèŒƒå›´åŒºé—´çš„ç´¢å¼•ä»˜å‡ºçš„I/Oæˆæœ¬å°±æ˜¯ï¼š

   ````
   1 x 1.0 = 1.0
   ````

   **`é¢„ä¼°èŒƒå›´å†…çš„è®°å½•æ•°`**

   ä¼˜åŒ–å™¨éœ€è¦è®¡ç®—ç´¢å¼•çš„æŸä¸ªèŒƒå›´åŒºé—´åˆ°åº•åŒ…å«å¤šå°‘æ¡è®°å½•ï¼Œå¯¹äºæœ¬ä¾‹æ¥è¯´å°±æ˜¯è¦è®¡ç®—PRIMARYåœ¨(10101, 20000) è¿™ä¸ªèŒƒå›´åŒºé—´ä¸­åŒ…å«å¤šå°‘æ¡æ•°æ®è®°å½•ï¼Œè®¡ç®—è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

   + æ­¥éª¤1ï¼šå…ˆæ ¹æ®emp_no > 10101è¿™ä¸ªæ¡ä»¶è®¿é—®ä¸€ä¸‹PRIMARYå¯¹åº”çš„B+æ ‘ç´¢å¼•ï¼Œæ‰¾åˆ°æ»¡è¶³emp_no > 10101è¿™ä¸ªæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œæˆ‘ä»¬æŠŠè¿™æ¡è®°å½•ç§°ä¹‹ä¸ºåŒºé—´æœ€å·¦è®°å½•ã€‚
   + æ­¥éª¤2ï¼šç„¶åå†æ ¹æ®emp_no < 20000è¿™ä¸ªæ¡ä»¶ç»§ç»­ä»PRIMARYå¯¹åº”çš„B+æ ‘ç´¢å¼•ä¸­æ‰¾å‡ºç¬¬ä¸€æ¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„è®°å½•ï¼Œæˆ‘ä»¬æŠŠè¿™æ¡è®°å½•ç§°ä¹‹ä¸ºåŒºé—´æœ€å³è®°å½•ã€‚
   + æ­¥éª¤3ï¼šå¦‚æœåŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ç›¸éš”ä¸å¤ªè¿œï¼ˆåªè¦ç›¸éš”ä¸å¤§äº10ä¸ªé¡µé¢å³å¯ï¼‰ï¼Œé‚£å°±å¯ä»¥ç²¾ç¡®ç»Ÿè®¡å‡ºæ»¡è¶³emp_no > '10101' and emp_no < '20000'æ¡ä»¶çš„è®°å½•æ¡æ•°ã€‚å¦åˆ™åªæ²¿ç€åŒºé—´æœ€å·¦è®°å½•å‘å³è¯»10ä¸ªé¡µé¢ï¼Œè®¡ç®—å¹³å‡æ¯ä¸ªé¡µé¢ä¸­åŒ…å«å¤šå°‘è®°å½•ï¼Œç„¶åç”¨è¿™ä¸ªå¹³å‡å€¼ä¹˜ä»¥åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ä¹‹é—´çš„é¡µé¢æ•°é‡å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œæ€ä¹ˆä¼°è®¡åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ä¹‹é—´æœ‰å¤šå°‘ä¸ªé¡µé¢å‘¢ï¼Ÿè®¡ç®—å®ƒä»¬çˆ¶èŠ‚ç‚¹ä¸­å¯¹åº”çš„ç›®å½•é¡¹è®°å½•ä¹‹é—´éš”ç€å‡ æ¡è®°å½•å°±å¯ä»¥äº†ã€‚

   æ ¹æ®ä¸Šé¢çš„æ­¥éª¤å¯ä»¥ç®—å‡ºæ¥PRIMARYç´¢å¼•çš„è®°å½•æ¡æ•°ï¼Œæ‰€ä»¥è¯»å–è®°å½•çš„CPUæˆæœ¬ä¸ºï¼š26808*0.2 = 5361.6ï¼Œå…¶ä¸­26808æ˜¯é¢„ä¼°çš„éœ€è¦è¯»å–çš„æ•°æ®è®°å½•æ¡æ•°ï¼Œ0.2æ˜¯è¯»å–ä¸€æ¡è®°å½•æˆæœ¬å¸¸æ•°ã€‚

   **`PRIMARYçš„æ€»æˆæœ¬`**

   ç¡®å®šè®¿é—®çš„IOæˆæœ¬+è¿‡æ»¤æ•°æ®çš„CPUæˆæœ¬ = 1 + 5361.6 = 5362.6

   è¿™ç‚¹ä¹Ÿåœ¨ä¼˜åŒ–æ—¥å¿—é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼š

   ````json
   
   ````

   

4. è®¡ç®—`idx_titles_to_date`æˆæœ¬

   å› ä¸ºé€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢éœ€è¦å›è¡¨ï¼Œæ‰€ä»¥åœ¨è®¡ç®—äºŒçº§ç´¢å¼•éœ€è¦æˆæœ¬æ—¶è¿˜è¦åŠ ä¸Šå›è¡¨çš„æˆæœ¬ï¼Œè€Œå›è¡¨çš„æˆæœ¬å°±ç›¸å½“äº ä¸‹é¢è¿™ä¸ªSQLæ‰§è¡Œï¼š

   ```sql
   select * from employees.titles where ä¸»é”®å­—æ®µ in (ä¸»é”®å€¼1ï¼Œä¸»é”®å€¼2ï¼Œ....);
   ```

   æ‰€ä»¥idx_titles_to_dateçš„æˆæœ¬ = è¾…åŠ©ç´¢å¼•çš„æŸ¥è¯¢æˆæœ¬ + å›è¡¨æŸ¥è¯¢çš„æˆæœ¬

5. æ¯”è¾ƒå„æˆæœ¬é€‰å‡ºæœ€ä¼˜è€…

   é€‰å‡ºæˆæœ¬æœ€å°çš„ç´¢å¼•

#### åŸºäºç´¢å¼•ç»Ÿè®¡æ•°æ®çš„æˆæœ¬è®¡ç®—

æœ‰æ—¶å€™ä½¿ç”¨ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ä¼šæœ‰è®¸å¤šå•ç‚¹åŒºé—´ï¼Œæ¯”å¦‚ä½¿ç”¨INè¯­å¥å°±å¾ˆå®¹æ˜“äº§ç”Ÿéå¸¸å¤šçš„å•ç‚¹åŒºé—´ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ª æŸ¥è¯¢ï¼š

````sql
select * from employees.titles where to_date in ('a','b','c','d', ..., 'e');
````

å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°çš„ç´¢å¼•å°±æ˜¯idx_titles_to_dateï¼Œç”±äºè¿™ä¸ªç´¢å¼•å¹¶ä¸æ˜¯å”¯ä¸€äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç¡® å®šä¸€ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•çš„æ¡æ•°æœ‰å¤šå°‘ï¼Œéœ€è¦æˆ‘ä»¬å»è®¡ç®—ã€‚è®¡ç®—æ–¹å¼æˆ‘ä»¬ä¸Šè¾¹å·²ç»ä»‹ç»è¿‡äº†ï¼Œå°±æ˜¯å…ˆ è·å–ç´¢å¼•å¯¹åº”çš„B+æ ‘çš„åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ï¼Œç„¶åå†è®¡ç®—è¿™ä¸¤æ¡è®°å½•ä¹‹é—´æœ‰å¤šå°‘è®°å½•ï¼ˆè®°å½•æ¡æ•°å°‘çš„æ—¶ å€™å¯ä»¥åšåˆ°ç²¾ç¡®è®¡ç®—ï¼Œå¤šçš„æ—¶å€™åªèƒ½ä¼°ç®—ï¼‰ã€‚è¿™ç§é€šè¿‡ç›´æ¥è®¿é—®ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¥è®¡ç®—æŸä¸ªèŒƒå›´åŒºé—´å¯¹åº”çš„ç´¢å¼• è®°å½•æ¡æ•°çš„æ–¹å¼ç§°ä¹‹ä¸º`index dive`ã€‚

å¦‚æœåªæœ‰å‡ ä¸ªå•ç‚¹åŒºé—´çš„è¯ï¼Œä½¿ç”¨index diveçš„æ–¹å¼å»è®¡ç®—è¿™äº›å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°ä¹Ÿä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå¯æ˜¯å¦‚æœå¾ˆå¤šå‘¢ï¼Œæ¯”å¦‚æœ‰20000æ¬¡ï¼ŒMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸ºäº†è®¡ç®—è¿™äº›å•ç‚¹åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°ï¼Œè¦è¿›è¡Œ20000æ¬¡ index diveæ“ä½œï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹æ˜¯å¾ˆè€—æ€§èƒ½çš„ï¼Œæ‰€ä»¥MySQLæä¾›äº†ä¸€ä¸ªç³»ç»Ÿå˜é‡eq_range_index_dive_limitï¼Œ æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç³»ç»Ÿå˜é‡çš„é»˜è®¤å€¼ï¼š `SHOW VARIABLES LIKE '%dive%';` ä¸º200ã€‚

ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬çš„INè¯­å¥ä¸­çš„å‚æ•°ä¸ªæ•°å°äº200ä¸ªçš„è¯ï¼Œå°†ä½¿ç”¨index diveçš„æ–¹å¼è®¡ç®—å„ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½• æ¡æ•°ï¼Œå¦‚æœå¤§äºæˆ–ç­‰äº200ä¸ªçš„è¯ï¼Œå¯å°±ä¸èƒ½ä½¿ç”¨index diveäº†ï¼Œè¦ä½¿ç”¨æ‰€è°“çš„ç´¢å¼•ç»Ÿè®¡æ•°æ®æ¥è¿›è¡Œä¼°ç®—ã€‚åƒä¼šä¸º æ¯ä¸ªè¡¨ç»´æŠ¤ä¸€ä»½ç»Ÿè®¡æ•°æ®ä¸€æ ·ï¼ŒMySQLä¹Ÿä¼šä¸ºè¡¨ä¸­çš„æ¯ä¸€ä¸ªç´¢å¼•ç»´æŠ¤ä¸€ä»½ç»Ÿè®¡æ•°æ®ï¼ŒæŸ¥çœ‹æŸä¸ªè¡¨ä¸­ç´¢å¼•çš„ç»Ÿè®¡æ•° æ®å¯ä»¥ä½¿ç”¨ `SHOW INDEX FROM è¡¨å` çš„è¯­æ³•ã€‚

Cardinalityå±æ€§è¡¨ç¤ºç´¢å¼•åˆ—ä¸­ä¸é‡å¤å€¼çš„ä¸ªæ•°ã€‚æ¯”å¦‚å¯¹äºä¸€ä¸ªä¸€ä¸‡è¡Œè®°å½•çš„è¡¨æ¥è¯´ï¼ŒæŸä¸ªç´¢å¼•åˆ—çš„Cardinalityå± æ€§æ˜¯10000ï¼Œé‚£æ„å‘³ç€è¯¥åˆ—ä¸­æ²¡æœ‰é‡å¤çš„å€¼ï¼Œå¦‚æœCardinalityå±æ€§æ˜¯1çš„è¯ï¼Œå°±æ„å‘³ç€è¯¥åˆ—çš„å€¼å…¨éƒ¨æ˜¯é‡å¤çš„ã€‚ä¸ è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œä½¿ç”¨SHOW INDEXè¯­å¥å±•ç¤ºå‡ºæ¥çš„æŸä¸ªç´¢å¼•åˆ—çš„Cardinalityå±æ€§æ˜¯ ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¹¶ä¸æ˜¯ç²¾ç¡®çš„ã€‚å¯ä»¥æ ¹æ®è¿™ä¸ªå±æ€§æ¥ä¼°ç®—INè¯­å¥ä¸­çš„å‚æ•°æ‰€å¯¹åº”çš„è®°å½•æ•°ï¼š

+ ä½¿ç”¨SHOW TABLE STATUSå±•ç¤ºå‡ºçš„Rowså€¼ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¡¨ä¸­æœ‰å¤šå°‘æ¡è®°å½•ã€‚
+ ä½¿ç”¨SHOW INDEXè¯­å¥å±•ç¤ºå‡ºçš„Cardinalityå±æ€§ã€‚
+ æ ¹æ®ä¸Šé¢ä¸¤ä¸ªå€¼å¯ä»¥ç®—å‡ºidx_key1ç´¢å¼•å¯¹äºçš„key1åˆ—å¹³å‡å•ä¸ªå€¼çš„é‡å¤æ¬¡æ•°ï¼šRows/Cardinality
+ æ‰€ä»¥æ€»å…±éœ€è¦å›è¡¨çš„è®°å½•æ•°å°±æ˜¯ï¼šINè¯­å¥ä¸­çš„å‚æ•°ä¸ªæ•°*Rows/Cardinality

## NULLå€¼ç»Ÿè®¡

ä¸Šé¢çŸ¥é“åœ¨ç»Ÿè®¡åˆ—ä¸é‡å¤å€¼çš„æ—¶å€™ï¼Œä¼šå½±å“åˆ°æŸ¥è¯¢ä¼˜åŒ–å™¨ã€‚

å¯¹äºNULLï¼Œæœ‰ä¸‰ç§ç†è§£æ–¹å¼ï¼š

1. NULLå€¼ä»£è¡¨ä¸€ä¸ªæœªç¡®å®šçš„å€¼ï¼Œæ¯ä¸€ä¸ªNULLå€¼éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œåœ¨ç»Ÿè®¡åˆ—ä¸é‡å¤å€¼çš„æ—¶å€™åº”è¯¥éƒ½å½“ä½œç‹¬ ç«‹çš„ã€‚
2. NULLå€¼åœ¨ä¸šåŠ¡ä¸Šå°±æ˜¯ä»£è¡¨æ²¡æœ‰ï¼Œæ‰€æœ‰çš„NULLå€¼ä»£è¡¨çš„æ„ä¹‰æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„NULLå€¼éƒ½ä¸€æ ·ï¼Œåœ¨ç»Ÿ è®¡åˆ—ä¸é‡å¤å€¼çš„æ—¶å€™åº”è¯¥åªç®—ä¸€ä¸ªã€‚
3. NULLå®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼Œåœ¨ç»Ÿè®¡åˆ—ä¸é‡å¤å€¼çš„æ—¶å€™åº”è¯¥å¿½ç•¥NULLã€‚

innodbæä¾›äº†ä¸€ä¸ªç³»ç»Ÿå˜é‡ï¼š

```sql
show global variables like '%innodb_stats_method%';
```

è¿™ä¸ªå˜é‡æœ‰ä¸‰ä¸ªå€¼ï¼š

1. nulls_equalï¼šè®¤ä¸ºæ‰€æœ‰NULLå€¼éƒ½æ˜¯ç›¸ç­‰çš„ã€‚è¿™ä¸ªå€¼ä¹Ÿæ˜¯innodb_stats_methodçš„é»˜è®¤å€¼ã€‚å¦‚æœæŸä¸ªç´¢å¼•åˆ—ä¸­NULLå€¼ç‰¹åˆ«å¤šçš„è¯ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼ä¼šè®©ä¼˜åŒ–å™¨è®¤ä¸ºæŸä¸ªåˆ—ä¸­å¹³å‡ä¸€ä¸ªå€¼é‡å¤æ¬¡æ•°ç‰¹åˆ«å¤šï¼Œæ‰€ä»¥å€¾å‘äºä¸ä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚
2. nulls_unequalï¼šè®¤ä¸ºæ‰€æœ‰NULLå€¼éƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚å¦‚æœæŸä¸ªç´¢å¼•åˆ—ä¸­NULLå€¼ç‰¹åˆ«å¤šçš„è¯ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼ä¼šè®©ä¼˜åŒ–å™¨è®¤ä¸ºæŸä¸ªåˆ—ä¸­å¹³å‡ä¸€ä¸ªå€¼é‡å¤æ¬¡æ•°ç‰¹åˆ«å°‘ï¼Œæ‰€ä»¥å€¾å‘äºä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚
3. nulls_ignoredï¼šç›´æ¥æŠŠNULLå€¼å¿½ç•¥æ‰ã€‚

**æœ€å¥½ä¸åœ¨ç´¢å¼•åˆ—ä¸­å­˜æ”¾NULLå€¼æ‰æ˜¯æ­£è§£**

## ç»Ÿè®¡æ•°æ®

InnoDBæä¾›äº†ä¸¤ç§å­˜å‚¨ç»Ÿè®¡æ•°æ®çš„æ–¹å¼

+ ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚
+ ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå½“æœåŠ¡å™¨å…³é—­æ—¶è¿™äº›è¿™äº›ç»Ÿè®¡æ•°æ®å°±éƒ½è¢«æ¸…é™¤æ‰äº†ã€‚

MySQLç»™æˆ‘ä»¬æä¾›äº†ç³»ç»Ÿå˜é‡innodb_stats_persistentæ¥æ§åˆ¶åˆ°åº•é‡‡ç”¨å“ªç§æ–¹å¼å»å­˜å‚¨ç»Ÿè®¡æ•°æ®ã€‚åœ¨MySQL 5.6.6ä¹‹å‰ï¼Œinnodb_stats_persistentçš„å€¼é»˜è®¤æ˜¯OFFï¼Œä¹Ÿå°±æ˜¯è¯´InnoDBçš„ç»Ÿè®¡æ•°æ®é»˜è®¤æ˜¯å­˜å‚¨åˆ°å†…å­˜çš„ï¼Œä¹‹åçš„ ç‰ˆæœ¬ä¸­innodb_stats_persistentçš„å€¼é»˜è®¤æ˜¯ONï¼Œä¹Ÿå°±æ˜¯ç»Ÿè®¡æ•°æ®é»˜è®¤è¢«å­˜å‚¨åˆ°ç£ç›˜ä¸­ã€‚

ä¸è¿‡InnoDBé»˜è®¤æ˜¯ä»¥è¡¨ä¸ºå•ä½æ¥æ”¶é›†å’Œå­˜å‚¨ç»Ÿè®¡æ•°æ®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æŠŠæŸäº›è¡¨çš„ç»Ÿè®¡æ•°æ®ï¼ˆä»¥åŠè¯¥è¡¨çš„ç´¢ å¼•ç»Ÿè®¡æ•°æ®ï¼‰å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ŒæŠŠå¦ä¸€äº›è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºå’Œä¿®æ”¹è¡¨çš„æ—¶å€™é€šè¿‡æŒ‡å®š STATS_PERSISTENTå±æ€§æ¥æŒ‡æ˜è¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨æ–¹å¼ã€‚

### åŸºäºç£ç›˜çš„æ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®

å½“æˆ‘ä»¬é€‰æ‹©æŠŠæŸä¸ªè¡¨ä»¥åŠè¯¥è¡¨ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®å­˜æ”¾åˆ°ç£ç›˜ä¸Šæ—¶ï¼Œå®é™…ä¸Šæ˜¯æŠŠè¿™äº›ç»Ÿè®¡æ•°æ®å­˜å‚¨åˆ°äº†ä¸¤ä¸ªè¡¨é‡Œï¼š

+ innodb_table_statså­˜å‚¨äº†å…³äºè¡¨çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªè¡¨çš„ç»Ÿè®¡æ•°æ®
+ nnodb_index_statså­˜å‚¨äº†å…³äºç´¢å¼•çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªç´¢å¼•çš„ä¸€ä¸ªç»Ÿè®¡é¡¹çš„ç»Ÿè®¡æ•°æ®

### å®šæœŸæ›´æ–°ç»Ÿè®¡æ•°æ®

+ ç³»ç»Ÿå˜é‡innodb_stats_auto_recalcå†³å®šç€æœåŠ¡å™¨æ˜¯å¦è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯ONï¼Œ ä¹Ÿå°±æ˜¯è¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ã€‚æ¯ä¸ªè¡¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡è®°å½•ç€å¯¹è¯¥è¡¨è¿›è¡Œå¢åˆ æ”¹çš„è®°å½•æ¡æ•°ï¼Œå¦‚æœå‘ç”Ÿå˜åŠ¨çš„è®°å½•æ•°é‡è¶…è¿‡äº†è¡¨å¤§å°çš„10%ï¼Œå¹¶ä¸”è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®çš„åŠŸèƒ½æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šé‡æ–°è¿›è¡Œä¸€æ¬¡ç»Ÿè®¡æ•°æ®çš„è®¡ç®—ï¼Œå¹¶ä¸”æ›´æ–°innodb_table_statså’Œ innodb_index_statsè¡¨ã€‚ä¸è¿‡è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯å³ä½¿è¡¨ä¸­å˜åŠ¨çš„ è®°å½•æ•°è¶…è¿‡äº†10%ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ä¹Ÿä¸ä¼šç«‹å³å‘ç”Ÿï¼Œå¯èƒ½ä¼šå»¶è¿Ÿå‡ ç§’æ‰ä¼šè¿›è¡Œè®¡ç®—ã€‚
+ å¦‚æœinnodb_stats_auto_recalcç³»ç»Ÿå˜é‡çš„å€¼ä¸ºOFFçš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨ANALYZE TABLEè¯­ å¥æ¥é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ã€‚ `ANALYZE TABLE single_table;`

## æ§åˆ¶æ‰§è¡Œè®¡åˆ’

### `Index Hints`

+ USE INDEXï¼šé™åˆ¶ç´¢å¼•çš„ä½¿ç”¨èŒƒå›´ï¼Œæˆ‘ä»¬åœ¨æ•°æ®è¡¨é‡Œå»ºç«‹äº†å¾ˆå¤šç´¢å¼•ï¼Œå½“MySQLå¯¹ç´¢å¼•è¿›è¡Œé€‰æ‹©æ—¶ï¼Œè¿™äº›ç´¢å¼•éƒ½åœ¨è€ƒè™‘çš„èŒƒå›´å†…ã€‚ä½†æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›MySQLåªè€ƒè™‘å‡ ä¸ªç´¢å¼•ï¼Œè€Œä¸æ˜¯å…¨éƒ¨çš„ç´¢å¼•ï¼Œ è¿™å°±éœ€è¦ç”¨åˆ°USE INDEXå¯¹æŸ¥è¯¢è¯­å¥è¿›è¡Œè®¾ç½®ã€‚
+ IGNORE INDEX ï¼šé™åˆ¶ä¸ä½¿ç”¨ç´¢å¼•çš„èŒƒå›´
+ FORCE INDEXï¼šæˆ‘ä»¬å¸Œæœ›MySQLå¿…é¡»è¦ä½¿ç”¨æŸä¸€ä¸ªç´¢å¼•(ç”±äº MySQLåœ¨æŸ¥è¯¢æ—¶åªèƒ½ä½¿ç”¨ä¸€ä¸ªç´¢ å¼•ï¼Œå› æ­¤åªèƒ½å¼ºè¿«MySQLä½¿ç”¨ä¸€ä¸ªç´¢å¼•)ã€‚è¿™å°±éœ€è¦ä½¿ç”¨FORCE INDEXæ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚

`````sql
SELECT * FROM table1 USE|IGNORE|FORCE INDEX (col1_index,col2_index) WHERE col1=1 AND
col2=2 AND col3=3;
`````

## å…³äºJOINçš„ä¼˜åŒ–

### å†…è¿æ¥

ä¸€ä¸‹ä¸‰ç§å†™æ³•éƒ½æ˜¯å†…è¿æ¥ï¼š

````sql
mysql> select * from t1 join t2 on t1.a = t2.a;
mysql> select * from t1 inner join t2 on t1.a = t2.a;
mysql> select * from t1 cross join t2 on t1.a = t2.a;
````

### å·¦è¿æ¥ã€å³è¿æ¥

å·¦è¿æ¥ï¼š

````sql
mysql> select * from t1 left join t2 on t1.a = t2.a;
````

å³è¿æ¥ï¼š

````sql
mysql> select * from t1 right join t2 on t1.a = t2.a;
````

### è¿æ¥çš„åŸç†

ä¸ç®¡æ˜¯å†…è¿æ¥è¿˜æ˜¯å·¦å³è¿æ¥ï¼Œéƒ½éœ€è¦ä¸€ä¸ªé©±åŠ¨è¡¨å’Œä¸€ä¸ªè¢«é©±åŠ¨è¡¨ï¼Œå¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œé€‰å–å“ªä¸ªè¡¨ä¸ºé©±åŠ¨è¡¨éƒ½æ²¡å…³ç³»ï¼Œè€Œå¤–è¿æ¥çš„é©±åŠ¨è¡¨æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å·¦è¿æ¥çš„é©±åŠ¨è¡¨å°±æ˜¯å·¦è¾¹çš„é‚£ä¸ªè¡¨ï¼Œå³è¿æ¥çš„é©±åŠ¨è¡¨å°±æ˜¯å³è¾¹çš„é‚£ä¸ª è¡¨ã€‚

è¿æ¥çš„å¤§è‡´åŸç†æ˜¯ï¼š

1. é€‰å–é©±åŠ¨è¡¨ï¼Œä½¿ç”¨ä¸é©±åŠ¨è¡¨ç›¸å…³çš„è¿‡æ»¤æ¡ä»¶ï¼Œé€‰å–ä»£ä»·æœ€ä½çš„è®¿é—®å½¢å¼æ¥æ‰§è¡Œå¯¹é©±åŠ¨è¡¨çš„å•è¡¨æŸ¥è¯¢ã€‚
2. å¯¹ä¸Šä¸€æ­¥éª¤ä¸­æŸ¥è¯¢é©±åŠ¨è¡¨å¾—åˆ°çš„ç»“æœé›†ä¸­æ¯ä¸€æ¡è®°å½•ï¼Œéƒ½åˆ†åˆ«åˆ°è¢«é©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ã€‚

å¯¹åº”ä¼ªä»£ç å°±æ˜¯ï¼š

````java
for each row in t1 { //éå†æ»¡è¶³t1å•è¡¨æŸ¥è¯¢ç»“æœé›†çš„æ¯ä¸€æ¡è®°å½•
 for each row in t2 { //å¯¹äºæŸæ¡t1è¡¨çš„è®°å½•æ¥è¯´ï¼Œéå†æ»¡è¶³å¯¹t2å•è¡¨æŸ¥è¯¢ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½•
 		// åˆ¤æ–­æ˜¯å¦ç¬¦åˆjoinæ¡ä»¶
 }
}
````

#### åµŒå¥—å¾ªç¯è¿æ¥

ä¸Šé¢çš„è¿‡ç¨‹å°±åƒæ˜¯ä¸€ä¸ªåµŒå¥—çš„å¾ªç¯ï¼Œæ‰€ä»¥è¿™ç§é©±åŠ¨è¡¨åªè®¿é—®ä¸€æ¬¡ï¼Œä½†è¢«é©±åŠ¨è¡¨å´å¯èƒ½è¢«å¤šæ¬¡è®¿é—®ï¼Œè®¿é—®æ¬¡æ•°å–å†³äºå¯¹é©±åŠ¨è¡¨æ‰§è¡Œå•è¡¨æŸ¥è¯¢åçš„ç»“æœé›†ä¸­çš„è®°å½•æ¡æ•°çš„è¿æ¥æ‰§è¡Œæ–¹å¼ç§°ä¹‹ä¸ºåµŒå¥—å¾ªç¯è¿æ¥(Nested-Loop Join),è¿™æ˜¯æœ€ç®€å•ï¼Œä¹Ÿæ˜¯æœ€ç¬¨æ‹™çš„ä¸€ç§è¿æ¥æŸ¥è¯¢ç®—æ³•ã€‚

æ¯”å¦‚å¯¹äºä¸‹é¢è¿™ä¸ªsqlï¼š

````sql
mysql> select * from t1 join t2 on t1.a = t2.a where t1.b in (1,2);
````

å…ˆä¼šæ‰§è¡Œ

````sql
mysql> select * from t1 where t1.b in (1,2);
+---+------+------+------+------+
| a | b | c | d | e |
+---+------+------+------+------+
| 1 | 1 | 1 | 1 | a |
| 2 | 2 | 2 | 2 | b |
| 5 | 2 | 3 | 5 | e |
+---+------+------+------+------+
3 rows in set (0.00 sec)
````

å¾—åˆ°ä¸‰æ¡è®°å½•ã€‚

ç„¶ååˆ†åˆ«æ‰§è¡Œï¼š

````sql
mysql> select * from t2 where t2.a = 1;
mysql> select * from t2 where t2.a = 2;
mysql> select * from t2 where t2.a = 5;
````

æ‰€ä»¥å®é™…ä¸Šå¯¹äºä¸Šé¢çš„æ­¥éª¤ï¼Œå®é™…ä¸Šéƒ½æ˜¯é’ˆå¯¹å•è¡¨çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨ç´¢å¼•æ¥å¸®åŠ©æŸ¥è¯¢ã€‚

### åŸºäºå—çš„å¾ªç¯åµŒå¥—è¿æ¥

æ‰«æä¸€ä¸ªè¡¨çš„è¿‡ç¨‹å…¶å®æ˜¯å…ˆæŠŠè¿™ä¸ªè¡¨ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åä»å†…å­˜ä¸­æ¯”è¾ƒåŒ¹é…æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚ç°å®ç”Ÿæ´»ä¸­ çš„è¡¨å¯ä¸åƒt1ã€t2è¿™ç§åªæœ‰å‡ æ¡è®°å½•ï¼Œå¯èƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„æ•°æ®ã€‚å†…å­˜é‡Œå¯èƒ½å¹¶ä¸èƒ½å®Œå…¨å­˜æ”¾çš„ä¸‹è¡¨ä¸­æ‰€æœ‰çš„è®° å½•ï¼Œæ‰€ä»¥åœ¨æ‰«æè¡¨å‰è¾¹è®°å½•çš„æ—¶å€™åè¾¹çš„è®°å½•å¯èƒ½è¿˜åœ¨ç£ç›˜ä¸Šï¼Œç­‰æ‰«æåˆ°åè¾¹è®°å½•çš„æ—¶å€™å¯èƒ½å†…å­˜ä¸è¶³ï¼Œæ‰€ä»¥éœ€ è¦æŠŠå‰è¾¹çš„è®°å½•ä»å†…å­˜ä¸­é‡Šæ”¾æ‰ã€‚æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œé‡‡ç”¨**åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•**ï¼ŒåµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•çš„ä¸¤è¡¨è¿æ¥è¿‡ç¨‹ä¸­ï¼Œè¢«é©±åŠ¨è¡¨å¯æ˜¯è¦è¢«è®¿é—®å¥½å¤šæ¬¡çš„ï¼Œå¦‚æœè¿™ä¸ªè¢«é©±åŠ¨è¡¨ä¸­çš„æ•°æ®ç‰¹åˆ«å¤šè€Œä¸”ä¸èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ï¼Œé‚£å°±ç›¸å½“äºè¦ä»ç£ç›˜ä¸Šè¯»å¥½å‡ æ¬¡è¿™ä¸ªè¡¨ï¼Œè¿™ä¸ªI/Oä»£ä»·å°±éå¸¸å¤§äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—æƒ³åŠæ³•ï¼šå°½é‡å‡å°‘è®¿é—®è¢«é©±åŠ¨è¡¨çš„æ¬¡æ•°**å°½é‡å‡å°‘è®¿é—®è¢«é©±åŠ¨è¡¨çš„æ¬¡æ•°**ã€‚

å½“è¢«é©±åŠ¨è¡¨ä¸­çš„æ•°æ®éå¸¸å¤šæ—¶ï¼Œæ¯æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨ï¼Œè¢«é©±åŠ¨è¡¨çš„è®°å½•ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œåœ¨å†…å­˜ä¸­çš„æ¯ä¸€æ¡è®°å½• åªä¼šå’Œé©±åŠ¨è¡¨ç»“æœé›†çš„ä¸€æ¡è®°å½•åšåŒ¹é…ï¼Œä¹‹åå°±ä¼šè¢«ä»å†…å­˜ä¸­æ¸…é™¤æ‰ã€‚ç„¶åå†ä»é©±åŠ¨è¡¨ç»“æœé›†ä¸­æ‹¿å‡ºå¦ä¸€æ¡è®° å½•ï¼Œå†ä¸€æ¬¡æŠŠè¢«é©±åŠ¨è¡¨çš„è®°å½•åŠ è½½åˆ°å†…å­˜ä¸­ä¸€éï¼Œå‘¨è€Œå¤å§‹ï¼Œé©±åŠ¨è¡¨ç»“æœé›†ä¸­æœ‰å¤šå°‘æ¡è®°å½•ï¼Œå°±å¾—æŠŠè¢«é©±åŠ¨è¡¨ä» ç£ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜ä¸­å¤šå°‘æ¬¡ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä¸å¯ä»¥åœ¨æŠŠè¢«é©±åŠ¨è¡¨çš„è®°å½•åŠ è½½åˆ°å†…å­˜çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§å’Œå¤šæ¡é©±åŠ¨è¡¨ä¸­ çš„è®°å½•åšåŒ¹é…ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘é‡å¤ä»ç£ç›˜ä¸ŠåŠ è½½è¢«é©±åŠ¨è¡¨çš„ä»£ä»·äº†ã€‚

Mysqlä¸­æœ‰ä¸€ä¸ªå«åš**join buffer**çš„æ¦‚å¿µï¼Œjoin bufferå°±æ˜¯æ‰§è¡Œè¿æ¥æŸ¥è¯¢å‰ç”³è¯·çš„ä¸€å—å›ºå®šå¤§å°çš„å†…å­˜ï¼Œå…ˆæŠŠè‹¥å¹²æ¡ é©±åŠ¨è¡¨ç»“æœé›†ä¸­çš„è®°å½•è£…åœ¨è¿™ä¸ªjoin bufferä¸­ï¼Œç„¶åå¼€å§‹æ‰«æè¢«é©±åŠ¨è¡¨ï¼Œæ¯ä¸€æ¡è¢«é©±åŠ¨è¡¨çš„è®°å½•ä¸€æ¬¡æ€§å’Œjoin bufferä¸­çš„å¤šæ¡é©±åŠ¨è¡¨è®°å½•åšåŒ¹é…ï¼Œå› ä¸ºåŒ¹é…çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ï¼Œæ‰€ä»¥è¿™æ ·å¯ä»¥æ˜¾è‘—å‡å°‘è¢«é©±åŠ¨è¡¨çš„I/O ä»£ä»·ã€‚

æœ€å¥½çš„æƒ…å†µæ˜¯join bufferè¶³å¤Ÿå¤§ï¼Œèƒ½å®¹çº³é©±åŠ¨è¡¨ç»“æœé›†ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œè¿™æ ·åªéœ€è¦è®¿é—®ä¸€æ¬¡è¢«é©±åŠ¨è¡¨å°±å¯ä»¥å®Œæˆ è¿æ¥æ“ä½œäº†ã€‚è¿™ç§åŠ å…¥äº†join bufferçš„åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ç§°ä¹‹ä¸ºåŸºäºå—çš„åµŒå¥—è¿æ¥ï¼ˆBlock Nested-Loop Joinï¼‰ç®— æ³•ã€‚

è¿™ä¸ªjoin bufferçš„å¤§å°æ˜¯å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°æˆ–è€…ç³»ç»Ÿå˜é‡join_buffer_sizeè¿›è¡Œé…ç½®ï¼Œé»˜è®¤å¤§å°ä¸º262144å­—èŠ‚ï¼ˆä¹Ÿ å°±æ˜¯256KBï¼‰ï¼Œæœ€å°å¯ä»¥è®¾ç½®ä¸º128å­—èŠ‚ã€‚å½“ç„¶ï¼Œå¯¹äºä¼˜åŒ–è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢æ¥è¯´ï¼Œæœ€å¥½æ˜¯ä¸ºè¢«é©±åŠ¨è¡¨åŠ ä¸Šæ•ˆç‡é«˜ çš„ç´¢å¼•ï¼Œå¦‚æœå®åœ¨ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œå¹¶ä¸”è‡ªå·±çš„æœºå™¨çš„å†…å­˜ä¹Ÿæ¯”è¾ƒå¤§å¯ä»¥å°è¯•è°ƒå¤§join_buffer_sizeçš„å€¼æ¥å¯¹è¿æ¥æŸ¥ è¯¢è¿›è¡Œä¼˜åŒ–

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé©±åŠ¨è¡¨çš„è®°å½•å¹¶ä¸æ˜¯æ‰€æœ‰åˆ—éƒ½ä¼šè¢«æ”¾åˆ°join bufferä¸­ï¼Œåªæœ‰æŸ¥è¯¢åˆ—è¡¨ä¸­çš„åˆ—å’Œè¿‡æ»¤æ¡ä»¶ä¸­çš„ åˆ—æ‰ä¼šè¢«æ”¾åˆ°join bufferä¸­ï¼Œæ‰€ä»¥å†æ¬¡æé†’æˆ‘ä»¬ï¼Œæœ€å¥½ä¸è¦æŠŠ*ä½œä¸ºæŸ¥è¯¢ç›®æ ‡ï¼Œåªéœ€è¦æŠŠæˆ‘ä»¬å…³å¿ƒçš„åˆ—æ”¾åˆ°æŸ¥è¯¢åˆ— è¡¨å°±å¥½äº†ï¼Œè¿™æ ·å¯ä»¥åœ¨join bufferä¸­æ”¾ç½®æ›´å¤šçš„è®°å½•ã€‚

### å¤–è¿æ¥æ¶ˆé™¤

å†…è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨çš„ä½ç½®å¯ä»¥ç›¸äº’è½¬æ¢ï¼Œè€Œå·¦è¿æ¥å’Œå³è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨æ˜¯å›ºå®šçš„ã€‚è¿™å°±å¯¼è‡´å†… è¿æ¥å¯èƒ½é€šè¿‡ä¼˜åŒ–è¡¨çš„è¿æ¥é¡ºåºæ¥é™ä½æ•´ä½“çš„æŸ¥è¯¢æˆæœ¬ï¼Œè€Œå¤–è¿æ¥å´æ— æ³•ä¼˜åŒ–è¡¨çš„è¿æ¥é¡ºåºã€‚

å¤–è¿æ¥å’Œå†…è¿æ¥çš„æœ¬è´¨åŒºåˆ«å°±æ˜¯ï¼š**å¯¹äºå¤–è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•æ¥è¯´ï¼Œå¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…å¯¹äºå¤–è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•æ¥è¯´ï¼Œå¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…ONå­å­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä»ç„¶ä¼šè¢«åŠ å…¥åˆ°ç»“æœé›†ä¸­ï¼Œå¯¹åº”çš„è¢«é©±åŠ¨è¡¨è®°å½•çš„å„ä¸ªå­—æ®µä½¿ç”¨NULLå€¼å¡«å……ï¼›è€Œå†…è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•å¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä¼šè¢«èˆå¼ƒ.**

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªsql:

```sql
mysql> explain select * from t1 left join t2 on t1.a = t2.a where t1.a in (1,9);
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key | key_len |
ref | rows | filtered | Extra |
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
| 1 | SIMPLE | t1 | NULL | range | PRIMARY | PRIMARY | 4 |
NULL | 2 | 100.00 | Using where |
| 1 | SIMPLE | t2 | NULL | eq_ref | PRIMARY | PRIMARY | 4 |
luban.t1.a | 1 | 100.00 | NULL |
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)
```

è¿™ä¸ªå·¦è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨æ˜¯å›ºå®šå¥½äº†çš„ï¼Œè€Œå¦‚æœå°†ä¸Šé¢çš„sqlè¯­å¥æ”¹æˆï¼š

````sql
mysql> explain select * from t1 left join t2 on t1.a = t2.a where t1.a in (1,9) and
t2.b is not null;
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key | key_len |
ref | rows | filtered | Extra |
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
| 1 | SIMPLE | t2 | NULL | range | PRIMARY | PRIMARY | 4 |
NULL | 2 | 87.50 | Using where |
| 1 | SIMPLE | t1 | NULL | eq_ref | PRIMARY | PRIMARY | 4 |
luban.t2.a | 1 | 100.00 | NULL |
+----+-------------+-------+------------+--------+---------------+---------+---------
+------------+------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)
````

æˆ‘ä»¬å¯ä»¥å‘ç°é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨å‘ç”Ÿäº†å˜åŒ–ï¼Œå®é™…ä¸ŠåŠ ä¸Šäº†is not nullä¹‹åè¢«ä¼˜åŒ–æˆäº†å†…è¿æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨æŸ¥è¯¢ä¼˜ åŒ–å™¨é€‰æ‹©æœ€ä¼˜çš„è¿æ¥é¡ºåºäº†

## å…³äºå­æŸ¥è¯¢çš„ä¼˜åŒ–

ä¸‹é¢è¿™äº›sqléƒ½å«æœ‰å­æŸ¥è¯¢ï¼š

````sql
mysql> select * from t1 where a in (select a from t2);
mysql> select * from (select * from t1) as t;
````

### æŒ‰è¿”å›çš„ç»“æœé›†åŒºåˆ†å­æŸ¥è¯¢

#### æ ‡é‡å­æŸ¥è¯¢

é‚£äº›åªè¿”å›ä¸€ä¸ªå•ä¸€å€¼çš„å­æŸ¥è¯¢ç§°ä¹‹ä¸ºæ ‡é‡å­æŸ¥è¯¢ã€‚æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where a in (select max(a) from t2);
````

#### è¡Œå­æŸ¥è¯¢

è¿”å›ä¸€æ¡è®°å½•çš„å­æŸ¥è¯¢ï¼Œä¸è¿‡è¿™æ¡è®°å½•éœ€è¦åŒ…å«å¤šä¸ªåˆ—ã€‚æ¯”å¦‚ï¼š

```sql
mysql> select * from t1 where (a, b) = (select a, b from t2 limit 1);
```

#### åˆ—å­æŸ¥è¯¢

è¿”å›ä¸€ä¸ªåˆ—çš„æ•°æ®çš„å­æŸ¥è¯¢ï¼ŒåŒ…å«å¤šæ¡è®°å½•ã€‚æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where (a, b) in (select a,b from t2);
````

### æŒ‰ä¸å¤–å±‚æŸ¥è¯¢å…³ç³»æ¥åŒºåˆ†å­æŸ¥è¯¢

#### ç›¸å…³å­æŸ¥è¯¢

å¦‚æœå­æŸ¥è¯¢çš„æ‰§è¡Œéœ€è¦ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªå­æŸ¥è¯¢ç§°ä¹‹ä¸ºç›¸å…³å­æŸ¥è¯¢ã€‚æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where a in (select a from t2 where t1.a = t2.a);
````

#### ä¸ç›¸å…³å­æŸ¥è¯¢

å¦‚æœå­æŸ¥è¯¢å¯ä»¥å•ç‹¬è¿è¡Œå‡ºç»“æœï¼Œè€Œä¸ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªå­æŸ¥è¯¢ç§°ä¹‹ä¸ºä¸ç›¸å…³å­æŸ¥è¯¢ã€‚å‰ è¾¹ä»‹ç»çš„é‚£äº›å­æŸ¥è¯¢å…¨éƒ¨éƒ½å¯ä»¥çœ‹ä½œä¸ç›¸å…³å­æŸ¥è¯¢ã€‚

### å­æŸ¥è¯¢åœ¨MySqlä¸­æ˜¯æ€ä¹ˆæ‰§è¡Œçš„

#### å¯¹äºä¸ç›¸å…³æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢

æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where a = (select a from t2 limit 1);
````

å®ƒçš„æ‰§è¡Œæ­¥éª¤ä¸ºï¼š

1. æ‰§è¡Œ`select a from t2 limit 1`è¿™ä¸ªå­æŸ¥è¯¢ã€‚
2. ç„¶ååœ¨å°†ä¸Šä¸€æ­¥å­æŸ¥è¯¢å¾—åˆ°çš„ç»“æœå½“ä½œå¤–å±‚æŸ¥è¯¢çš„å‚æ•°å†æ‰§è¡Œå¤–å±‚æŸ¥è¯¢`select * from t1 where a = ...;`

#### å¯¹äºç›¸å…³æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢

æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where b = (select b from t2 where t1.a = t2.a limit 1);
````

å®ƒçš„æ‰§è¡Œæ­¥éª¤ä¸ºï¼š

1. å…ˆä»å¤–å±‚æŸ¥è¯¢ä¸­è·å–ä¸€æ¡è®°å½•ï¼Œæœ¬ä¾‹ä¸­ä¹Ÿå°±æ˜¯å…ˆä»t1è¡¨ä¸­è·å–ä¸€æ¡è®°å½•ã€‚
2. ç„¶åä»ä¸Šä¸€æ­¥éª¤ä¸­è·å–çš„é‚£æ¡è®°å½•ä¸­æ‰¾å‡ºå­æŸ¥è¯¢ä¸­æ¶‰åŠåˆ°çš„å€¼ï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯ä»t1è¡¨ä¸­è·å–çš„é‚£æ¡è®°å½•ä¸­æ‰¾å‡ºt1.aåˆ—çš„å€¼ï¼Œç„¶åæ‰§è¡Œå­æŸ¥è¯¢ã€‚
3. æœ€åæ ¹æ®å­æŸ¥è¯¢çš„æŸ¥è¯¢ç»“æœæ¥æ£€æµ‹å¤–å±‚æŸ¥è¯¢WHEREå­å¥çš„æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå¦‚æœæˆç«‹ï¼Œå°±æŠŠå¤–å±‚æŸ¥è¯¢çš„é‚£æ¡è®°å½•åŠ å…¥åˆ°ç»“æœé›†ï¼Œå¦åˆ™å°±ä¸¢å¼ƒã€‚
4. å†æ¬¡æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œè·å–ç¬¬äºŒæ¡å¤–å±‚æŸ¥è¯¢ä¸­çš„è®°å½•ï¼Œä¾æ¬¡ç±»æ¨ã€‚ã€‚ã€‚

### INå­æŸ¥è¯¢ä¼˜åŒ–

mysqlå¯¹INå­æŸ¥è¯¢è¿›è¡Œäº†ä¼˜åŒ–

æ¯”å¦‚ï¼š

````sql
mysql> select * from t1 where a in (select a from t2);
````

å¯¹äºä¸ç›¸å…³çš„INå­æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†ä¸­çš„è®°å½•æ¡æ•°å¾ˆå°‘ï¼Œé‚£ä¹ˆæŠŠå­æŸ¥è¯¢å’Œå¤–å±‚æŸ¥è¯¢åˆ†åˆ«çœ‹æˆä¸¤ä¸ªå• ç‹¬çš„å•è¡¨æŸ¥è¯¢æ•ˆç‡è¿˜æ˜¯è›®é«˜çš„ï¼Œä½†æ˜¯å¦‚æœå•ç‹¬æ‰§è¡Œå­æŸ¥è¯¢åçš„ç»“æœé›†å¤ªå¤šçš„è¯ï¼Œå°±ä¼šå¯¼è‡´è¿™äº›é—®é¢˜ï¼š

+ ç»“æœé›†å¤ªå¤šï¼Œå¯èƒ½å†…å­˜ä¸­éƒ½æ”¾ä¸ä¸‹
+ å¯¹äºå¤–å±‚æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†å¤ªå¤šï¼Œé‚£å°±æ„å‘³ç€INå­å¥ä¸­çš„å‚æ•°ç‰¹åˆ«å¤šï¼Œè¿™ä¼šå¯¼è‡´ï¼š
  + æ— æ³•æœ‰æ•ˆçš„ä½¿ç”¨ç´¢å¼•ï¼Œåªèƒ½å¯¹å¤–å±‚æŸ¥è¯¢è¿›è¡Œå…¨è¡¨æ‰«æã€‚
  + åœ¨å¯¹å¤–å±‚æŸ¥è¯¢æ‰§è¡Œå…¨è¡¨æ‰«ææ—¶ï¼Œç”±äºINå­å¥ä¸­çš„å‚æ•°å¤ªå¤šï¼Œè¿™ä¼šå¯¼è‡´æ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆå’ŒINå­å¥ä¸­çš„å‚æ•°åŒ¹é…èŠ±è´¹çš„æ—¶é—´å¤ªé•¿ã€‚

åœ¨mysqlä¸­ï¼Œä¸ç›´æ¥å°†ä¸ç›¸å…³å­æŸ¥è¯¢çš„ç»“æœé›†å½“ä½œå¤–å±‚æŸ¥è¯¢çš„å‚æ•°ï¼Œè€Œæ˜¯å°†è¯¥ç»“æœé›†å†™å…¥ä¸€ä¸ªä¸´æ—¶è¡¨é‡Œã€‚å†™å…¥ä¸´æ—¶è¡¨çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

+ è¯¥ä¸´æ—¶è¡¨çš„åˆ—å°±æ˜¯å­æŸ¥è¯¢ç»“æœé›†ä¸­çš„åˆ—ã€‚
+ å†™å…¥ä¸´æ—¶è¡¨çš„è®°å½•ä¼šè¢«å»é‡ã€‚INè¯­å¥æ˜¯åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨æŸä¸ªé›†åˆä¸­ï¼Œé›†åˆä¸­çš„å€¼é‡ä¸é‡å¤å¯¹æ•´ä¸ªINè¯­å¥çš„ç»“æœå¹¶ä¸å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å°†ç»“æœé›†å†™å…¥ä¸´æ—¶è¡¨æ—¶å¯¹è®°å½•è¿›è¡Œå»é‡å¯ä»¥è®©ä¸´æ—¶è¡¨å˜å¾—æ›´å°ã€‚ä¸´æ—¶è¡¨ä¹Ÿæ˜¯ä¸ªè¡¨ï¼Œåªè¦ä¸ºè¡¨ä¸­è®°å½•çš„æ‰€æœ‰åˆ—å»ºç«‹ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•å°±å¯ä»¥è¿›è¡Œå»é‡ã€‚
+ ä¸€èˆ¬æƒ…å†µä¸‹å­æŸ¥è¯¢ç»“æœé›†ä¸ä¼šç‰¹åˆ«å¤§ï¼Œæ‰€ä»¥ä¼šä¸ºå®ƒå»ºç«‹åŸºäºå†…å­˜çš„ä½¿ç”¨Memoryå­˜å‚¨å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œè€Œä¸”ä¼šä¸ºè¯¥è¡¨å»ºç«‹å“ˆå¸Œç´¢å¼•ã€‚INè¯­å¥çš„æœ¬è´¨å°±æ˜¯åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨æŸä¸ªé›†åˆé‡Œï¼Œå¦‚æœé›†åˆä¸­çš„æ•°æ®å»ºç«‹äº†å“ˆå¸Œç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ¹é…çš„è¿‡ç¨‹å°±æ˜¯å¾ˆå¿«çš„ã€‚
+ å¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†éå¸¸å¤§ï¼Œè¶…è¿‡äº†ç³»ç»Ÿå˜é‡tmp_table_sizeæˆ–è€…max_heap_table_sizeï¼Œä¸´æ—¶è¡¨ä¼šè½¬è€Œä½¿ç”¨åŸºäºç£ç›˜çš„å­˜å‚¨å¼•æ“æ¥ä¿å­˜ç»“æœé›†ä¸­çš„è®°å½•ï¼Œç´¢å¼•ç±»å‹ä¹Ÿå¯¹åº”è½¬å˜ä¸ºB+æ ‘ç´¢å¼•ã€‚

> è¿™ä¸ªå°†å­æŸ¥è¯¢ç»“æœé›†ä¸­çš„è®°å½•ä¿å­˜åˆ°ä¸´æ—¶è¡¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºç‰©åŒ–ï¼ˆMaterializeï¼‰ã€‚é‚£ä¸ªå­˜å‚¨å­æŸ¥è¯¢ç»“æœé›†çš„ä¸´æ—¶è¡¨ç§°ä¹‹ä¸ºç‰©åŒ–è¡¨ã€‚æ­£å› ä¸ºç‰©åŒ–è¡¨ä¸­çš„è®°å½•éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ˆåŸºäºå†…å­˜çš„ç‰©åŒ–è¡¨æœ‰å“ˆå¸Œç´¢å¼•ï¼ŒåŸºäºç£ç›˜çš„æœ‰B+æ ‘ç´¢å¼•ï¼‰ï¼Œé€šè¿‡ç´¢å¼•æ‰§è¡ŒINè¯­å¥åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨å­æŸ¥è¯¢ç»“æœé›†ä¸­å˜å¾—éå¸¸å¿«ï¼Œä»è€Œæå‡äº†å­æŸ¥è¯¢è¯­å¥çš„æ€§èƒ½ã€‚

è¿˜æ˜¯å¯¹äºä¸Šé¢çš„é‚£ä¸ªsqlï¼š

````sql
mysql> select * from t1 where a in (select a from t2);
````

å½“æˆ‘ä»¬æŠŠå­æŸ¥è¯¢è¿›è¡Œç‰©åŒ–ä¹‹åï¼Œå‡è®¾å­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„åç§°ä¸ºmaterialized_tableï¼Œè¯¥ç‰©åŒ–è¡¨å­˜å‚¨çš„å­æŸ¥è¯¢ç»“æœé›†çš„ åˆ—ä¸ºm_valï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢å…¶å®å¯ä»¥ä»ä¸‹è¾¹ä¸¤ç§è§’åº¦æ¥çœ‹å¾…ï¼š

+ ä»è¡¨t1çš„è§’åº¦æ¥çœ‹å¾…ï¼Œæ•´ä¸ªæŸ¥è¯¢çš„æ„æ€å…¶å®æ˜¯ï¼šå¯¹äºt1è¡¨ä¸­çš„æ¯æ¡è®°å½•æ¥è¯´ï¼Œå¦‚æœè¯¥è®°å½•çš„aåˆ—çš„å€¼åœ¨å­æŸ¥è¯¢å¯¹åº”çš„ç‰©åŒ–è¡¨ä¸­ï¼Œåˆ™è¯¥è®°å½•ä¼šè¢«åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ã€‚
+ ä»å­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„è§’åº¦æ¥çœ‹å¾…ï¼Œæ•´ä¸ªæŸ¥è¯¢çš„æ„æ€å…¶å®æ˜¯ï¼šå¯¹äºå­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„æ¯ä¸ªå€¼æ¥è¯´ï¼Œå¦‚æœèƒ½åœ¨t1è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„aåˆ—çš„å€¼ä¸è¯¥å€¼ç›¸ç­‰çš„è®°å½•ï¼Œé‚£ä¹ˆå°±æŠŠè¿™äº›è®°å½•åŠ å…¥åˆ°æœ€ç»ˆçš„ç»“æœé›†ã€‚

ä¹Ÿå°±æ˜¯è¯´å…¶å®ä¸Šè¾¹çš„æŸ¥è¯¢å°±ç›¸å½“äºè¡¨s1å’Œå­æŸ¥è¯¢ç‰©åŒ–è¡¨materialized_tableè¿›è¡Œå†…è¿æ¥ï¼š

````sql
select * from t1 inner join materialized_table on t1.a = m_val;
````

è½¬åŒ–æˆå†…è¿æ¥ä¹‹åï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å°±å¯ä»¥è¯„ä¼°ä¸åŒè¿æ¥é¡ºåºéœ€è¦çš„æˆæœ¬æ˜¯å¤šå°‘ï¼Œé€‰å–æˆæœ¬æœ€ä½çš„é‚£ç§æŸ¥è¯¢æ–¹å¼æ‰§è¡Œ æŸ¥è¯¢ã€‚

è™½ç„¶å°†å­æŸ¥è¯¢è¿›è¡Œç‰©åŒ–ä¹‹åå†æ‰§è¡ŒæŸ¥è¯¢ä¼šæœ‰å»ºç«‹ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œä½†æ˜¯å¯ä»¥å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºJOINè¿˜æ˜¯ä¼šæ›´æœ‰æ•ˆç‡ä¸€ ç‚¹çš„ã€‚é‚£èƒ½ä¸èƒ½ä¸è¿›è¡Œç‰©åŒ–æ“ä½œç›´æ¥æŠŠå­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥å‘¢ã€‚

æˆ‘ä»¬å¯¹æ¯”ä¸‹é¢ä¸¤ä¸ªsqlï¼š

````sql
mysql> select * from t1 where a in (select a from t2);
mysql> select t1.* from t1 inner join t2 on t1.a = t2.a;
````

è¿™ä¸¤ä¸ªsqlçš„æŸ¥è¯¢ç»“æœå…¶å®å¾ˆåƒï¼Œåªæ˜¯è¯´å¯¹äºç¬¬äºŒä¸ªsqlçš„ç»“æœé›†æ²¡æœ‰å»é‡ï¼Œæ‰€ä»¥INå­æŸ¥è¯¢å’Œä¸¤è¡¨è¿æ¥ä¹‹é—´å¹¶ä¸å®Œå…¨ç­‰ä»·ï¼Œä½†æ˜¯å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥åˆçœŸçš„å¯ä»¥å……åˆ†å‘æŒ¥ä¼˜åŒ–å™¨çš„ä½œç”¨ï¼Œæ‰€ä»¥MySQLæå‡ºäº†ä¸€ä¸ªæ–°æ¦‚å¿µåŠè¿æ¥ï¼Œ**åŠè¿æ¥ï¼ˆsemi-joinï¼‰**ï¼Œå°†t1è¡¨å’Œt2è¡¨è¿›è¡ŒåŠè¿æ¥çš„æ„æ€å°±æ˜¯ï¼šå¯¹äºt1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œæˆ‘ä»¬åªå…³å¿ƒåœ¨t2è¡¨ä¸­æ˜¯å¦å­˜åœ¨ ä¸ä¹‹åŒ¹é…çš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸å…³å¿ƒå…·ä½“æœ‰å¤šå°‘æ¡è®°å½•ä¸ä¹‹åŒ¹é…ï¼Œæœ€ç»ˆçš„ç»“æœé›†ä¸­åªä¿ç•™t1è¡¨çš„è®°å½•ã€‚semi-join åªæ˜¯åœ¨MySQLå†…éƒ¨é‡‡ç”¨çš„ä¸€ç§æ‰§è¡Œå­æŸ¥è¯¢çš„æ–¹å¼ï¼ŒMySQLå¹¶æ²¡æœ‰æä¾›é¢å‘ç”¨æˆ·çš„semi-joinè¯­æ³• ã€‚

**é‚£ä¹ˆæ€ä¹ˆå®ç°semi-joinå‘¢ï¼Ÿ**

#### Table pulloutï¼ˆå­æŸ¥è¯¢ä¸­çš„è¡¨ä¸Šæ‹‰ï¼‰

å½“å­æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å¤„åªæœ‰ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—æ—¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå­æŸ¥è¯¢ä¸­çš„è¡¨ä¸Šæ‹‰åˆ°å¤–å±‚æŸ¥è¯¢çš„FROMå­å¥ä¸­ï¼Œ å¹¶æŠŠå­æŸ¥è¯¢ä¸­çš„æœç´¢æ¡ä»¶åˆå¹¶åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ä¸­ã€‚

æ¯”å¦‚ï¼š

`````sql
mysql> select * from t1 where a in (select a from t2 where t2.b = 1); -- aæ˜¯ä¸»é”®
`````

æˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠt2è¡¨ä¸Šæ‹‰åˆ°å¤–å±‚æŸ¥è¯¢çš„FROMå­å¥ä¸­ï¼Œå¹¶ä¸”æŠŠå­æŸ¥è¯¢ä¸­çš„æœç´¢æ¡ä»¶åˆå¹¶åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ ä¸­ï¼Œä¸Šæ‹‰ä¹‹åçš„æŸ¥è¯¢å°±æ˜¯è¿™æ ·çš„ï¼š

````sql
mysql> select * from t1 inner join t2 on t1.a = t2.a where t2.b = 1; -- aæ˜¯ä¸»é”®
````

#### DuplicateWeedout execution strategyï¼ˆé‡å¤å€¼æ¶ˆé™¤ï¼‰ã€‚

å¯¹äºè¿™ä¸ªæŸ¥è¯¢æ¥è¯´ï¼š

````sql
mysql> select * from t1 where a in (select e from t2 where t2.b = 1); -- eåªæ˜¯æ™®é€šå­—æ®µ
````

è½¬æ¢ä¸ºåŠè¿æ¥æŸ¥è¯¢åï¼Œt1è¡¨ä¸­çš„æŸæ¡è®°å½•å¯èƒ½åœ¨t2è¡¨ä¸­æœ‰å¤šæ¡åŒ¹é…çš„è®°å½•ï¼Œæ‰€ä»¥è¯¥æ¡è®°å½•å¯èƒ½å¤šæ¬¡è¢«æ·»åŠ åˆ°æœ€å çš„ç»“æœé›†ä¸­ï¼Œä¸ºäº†æ¶ˆé™¤é‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªä¸´æ—¶è¡¨é•¿è¿™æ ·ï¼š

```sql
CREATE TABLE tmp (
 id PRIMARY KEY
);
```

è¿™æ ·åœ¨æ‰§è¡Œè¿æ¥æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å½“æŸæ¡t1è¡¨ä¸­çš„è®°å½•è¦åŠ å…¥ç»“æœé›†æ—¶ï¼Œå°±é¦–å…ˆæŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼åŠ å…¥åˆ°è¿™ä¸ª ä¸´æ—¶è¡¨é‡Œï¼Œå¦‚æœæ·»åŠ æˆåŠŸï¼Œè¯´æ˜ä¹‹å‰è¿™æ¡t1è¡¨ä¸­çš„è®°å½•å¹¶æ²¡æœ‰åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ï¼Œç°åœ¨æŠŠè¯¥è®°å½•æ·»åŠ åˆ°æœ€ç»ˆçš„ç»“ æœé›†ï¼›å¦‚æœæ·»åŠ å¤±è´¥ï¼Œè¯´æ˜è¿™æ¡ä¹‹å‰è¿™æ¡t1è¡¨ä¸­çš„è®°å½•å·²ç»åŠ å…¥è¿‡æœ€ç»ˆçš„ç»“æœé›†ï¼Œè¿™é‡Œç›´æ¥æŠŠå®ƒä¸¢å¼ƒå°±å¥½äº†ï¼Œè¿™ ç§ä½¿ç”¨ä¸´æ—¶è¡¨æ¶ˆé™¤semi-joinç»“æœé›†ä¸­çš„é‡å¤å€¼çš„æ–¹å¼ç§°ä¹‹ä¸ºDuplicateWeedoutã€‚

#### FirstMatch execution strategyï¼ˆé¦–æ¬¡åŒ¹é…ï¼‰

FirstMatchæ˜¯ä¸€ç§æœ€åŸå§‹çš„åŠè¿æ¥æ‰§è¡Œæ–¹å¼ï¼Œå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„æ€è·¯ï¼Œå…ˆå–ä¸€æ¡å¤–å±‚æŸ¥è¯¢çš„ä¸­çš„è®°å½•ï¼Œç„¶ååˆ°å­ æŸ¥è¯¢çš„è¡¨ä¸­å¯»æ‰¾ç¬¦åˆåŒ¹é…æ¡ä»¶çš„è®°å½•ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ä¸€æ¡ï¼Œåˆ™å°†è¯¥å¤–å±‚æŸ¥è¯¢çš„è®°å½•æ”¾å…¥æœ€ç»ˆçš„ç»“æœé›†å¹¶ä¸”åœæ­¢æŸ¥æ‰¾ æ›´å¤šåŒ¹é…çš„è®°å½•ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™æŠŠè¯¥å¤–å±‚æŸ¥è¯¢çš„è®°å½•ä¸¢å¼ƒæ‰ï¼›ç„¶åå†å¼€å§‹å–ä¸‹ä¸€æ¡å¤–å±‚æŸ¥è¯¢ä¸­çš„è®°å½•ï¼Œé‡å¤ä¸Šè¾¹ è¿™ä¸ªè¿‡ç¨‹ã€‚

#### LooseScanï¼ˆæ¾æ•£ç´¢å¼•ï¼‰

å­æŸ¥è¯¢æ‰«æäº†éå”¯ä¸€ç´¢å¼•ï¼Œå› ä¸ºæ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæ‰€ä»¥å¯èƒ½æœ‰ç›¸åŒçš„å€¼ï¼Œå¯ä»¥åˆ©ç”¨ç´¢å¼•å»é‡

å¯¹äºæŸäº›ä½¿ç”¨INè¯­å¥çš„ç›¸å…³ç›¸å…³å­æŸ¥è¯¢ï¼Œæ¯”æ–¹è¿™ä¸ªæŸ¥è¯¢ï¼š

````sql
select * from t1 where a in (select b from t2 where t1.b = t2.b);
````

å®ƒå¯ä»¥è½¬æ¢ä¸ºåŠè¿æ¥ï¼š

```sql
select * from t1 semi join t2 on t1.a = t2.a and t1.b = t2.b;
```

ç„¶åå†ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„å‡ ç§semi-joinå®ç°æ–¹å¼æ¥è¿›è¡Œå®ç°ã€‚

**ä½†æ˜¯æ³¨æ„ï¼šç”±äºç›¸å…³å­æŸ¥è¯¢å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸èƒ½è½¬æ¢ä¸ºç‰©åŒ–è¡¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚**

ä¸æ˜¯æ‰€æœ‰åŒ…å«INå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥éƒ½å¯ä»¥è½¬æ¢ä¸ºsemi-joinï¼Œåªæœ‰å½¢å¦‚ä¸‹é¢è¿™æ ·çš„æŸ¥è¯¢æ‰å¯ä»¥è¢«è½¬æ¢ä¸ºsemi-joinï¼š

````sql
SELECT ... FROM outer_tables WHERE expr IN (SELECT ... FROM inner_tables ...) AND ...
````

æˆ–è€…

````sql
SELECT ... FROM outer_tables WHERE (oe1, oe2, ...) IN (SELECT ie1, ie2, ... FROM
inner_tables ...) AND ...
````

å¦‚ä¸€ä¸‹å‡ ç§æƒ…å†µå°±ä¸èƒ½è½¬æ¢ä¸ºsemi-joinï¼š

+ å¤–å±‚æŸ¥è¯¢çš„WHEREæ¡ä»¶ä¸­æœ‰å…¶ä»–æœç´¢æ¡ä»¶ä¸INå­æŸ¥è¯¢ç»„æˆçš„å¸ƒå°”è¡¨è¾¾å¼ä½¿ç”¨ORè¿æ¥èµ·æ¥
+ ä½¿ç”¨NOT INè€Œä¸æ˜¯INçš„æƒ…å†µ
+ å­æŸ¥è¯¢ä¸­åŒ…å«GROUP BYã€HAVINGæˆ–è€…èšé›†å‡½æ•°çš„æƒ…å†µ
+ å­æŸ¥è¯¢ä¸­åŒ…å«UNIONçš„æƒ…å†µ

é‚£ä¹ˆå¯¹äºä¸èƒ½è½¬ä¸ºsemi-joinæŸ¥è¯¢çš„å­æŸ¥è¯¢ï¼Œæœ‰å…¶ä»–æ–¹å¼æ¥è¿›è¡Œä¼˜åŒ–ï¼š

+ å¯¹äºä¸ç›¸å…³å­æŸ¥è¯¢æ¥è¯´ï¼Œå¯ä»¥å°è¯•æŠŠå®ƒä»¬ç‰©åŒ–ä¹‹åå†å‚ä¸æŸ¥è¯¢

æ¯”å¦‚å¯¹äºä½¿ç”¨äº†NOT INä¸‹é¢è¿™ä¸ªsql:

````sql
select * from t1 where a not in (select a from t2 where t2.a = 1);
````

è¯·æ³¨æ„è¿™é‡Œå°†å­æŸ¥è¯¢ç‰©åŒ–ä¹‹åä¸èƒ½è½¬ä¸ºå’Œå¤–å±‚æŸ¥è¯¢çš„è¡¨çš„è¿æ¥ï¼Œå› ä¸ºç”¨çš„æ˜¯not inåªèƒ½æ˜¯å…ˆæ‰«æt1è¡¨ï¼Œç„¶åå¯¹t1è¡¨ çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œåˆ¤æ–­è¯¥è®°å½•çš„aå€¼åœ¨ä¸åœ¨ç‰©åŒ–è¡¨ä¸­ã€‚

+ ä¸ç®¡å­æŸ¥è¯¢æ˜¯ç›¸å…³çš„è¿˜æ˜¯ä¸ç›¸å…³çš„ï¼Œéƒ½å¯ä»¥æŠŠINå­æŸ¥è¯¢å°è¯•ä¸“ä¸ºEXISTSå­æŸ¥è¯¢

å…¶å®å¯¹äºä»»æ„ä¸€ä¸ªINå­æŸ¥è¯¢æ¥è¯´ï¼Œéƒ½å¯ä»¥è¢«è½¬ä¸ºEXISTSå­æŸ¥è¯¢ï¼Œé€šç”¨çš„ä¾‹å­å¦‚ä¸‹ï¼š

````sql
outer_expr IN (SELECT inner_expr FROM ... WHERE subquery_where)
````

å¯ä»¥è¢«è½¬æ¢ä¸ºï¼š

````sql
EXISTS (SELECT inner_expr FROM ... WHERE subquery_where AND outer_expr=inner_expr)
````

è¿™æ ·è½¬æ¢çš„å¥½å¤„æ˜¯ï¼Œè½¬æ¢å‰æœ¬æ¥ä¸èƒ½ç”¨åˆ°ç´¢å¼•ï¼Œä½†æ˜¯è½¬æ¢åå¯èƒ½å°±èƒ½ç”¨åˆ°ç´¢å¼•äº†ï¼Œæ¯”å¦‚ï¼š

````sql
select * from t1 where a in (select a from t2 where t2.e = t1.e);
````

è¿™ä¸ªsqlé‡Œé¢çš„å­æŸ¥è¯¢æ—¶ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œè½¬æ¢åå˜ä¸ºï¼š

````sql
select * from t1 where exists (select 1 from t2 where t2.e = t1.e and t1.a = t2.a);
````

è½¬æ¢ä¹‹åt2è¡¨å°±èƒ½ç”¨åˆ°aå­—æ®µçš„ç´¢å¼•äº†ã€‚

> æ‰€ä»¥ï¼Œå¦‚æœINå­æŸ¥è¯¢ä¸æ»¡è¶³è½¬æ¢ä¸ºsemi-joinçš„æ¡ä»¶ï¼Œåˆä¸èƒ½è½¬æ¢ä¸ºç‰©åŒ–è¡¨æˆ–è€…è½¬æ¢ä¸ºç‰©åŒ–è¡¨çš„æˆæœ¬å¤ªå¤§ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«è½¬æ¢ä¸ºEXISTSæŸ¥è¯¢ã€‚

## å¯¹äºæ´¾ç”Ÿè¡¨çš„ä¼˜åŒ–

````sql
mysql> select * from (select a, b from t1) as t;
````

ä¸Šé¢è¿™ä¸ªsqlï¼Œå­æŸ¥è¯¢æ˜¯æ”¾åœ¨fromåé¢çš„ï¼Œè¿™ä¸ªå­æŸ¥è¯¢çš„ç»“æœç›¸å½“äºä¸€ä¸ª**æ´¾ç”Ÿè¡¨**ï¼Œè¡¨çš„åç§°æ˜¯tï¼Œæœ‰aï¼Œbä¸¤ä¸ªå­—æ®µã€‚ å¯¹äºæ´¾ç”Ÿè¡¨ï¼Œæœ‰ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š

### æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–

æˆ‘ä»¬å¯ä»¥å°†æ´¾ç”Ÿè¡¨çš„ç»“æœé›†å†™åˆ°ä¸€ä¸ªå†…éƒ¨çš„ä¸´æ—¶è¡¨ä¸­ï¼Œç„¶åå°±æŠŠè¿™ä¸ªç‰©åŒ–è¡¨å½“ä½œæ™®é€šè¡¨ä¸€æ ·å‚ä¸æŸ¥è¯¢ã€‚å½“ç„¶ï¼Œåœ¨ å¯¹æ´¾ç”Ÿè¡¨è¿›è¡Œç‰©åŒ–æ—¶ï¼Œä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºå»¶è¿Ÿç‰©åŒ–çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯åœ¨æŸ¥è¯¢ä¸­çœŸæ­£ä½¿ç”¨åˆ°æ´¾ç”Ÿè¡¨æ—¶æ‰å›å»å°è¯•ç‰©åŒ–æ´¾ ç”Ÿè¡¨ï¼Œè€Œä¸æ˜¯è¿˜æ²¡å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢å°±æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–æ‰ã€‚æ¯”å¦‚ï¼š

````sql
select * from (select * from t1 where a = 1) as derived1 inner join t2 on derived1.a =
t2.a where t2.a =10;
````

å¦‚æœé‡‡ç”¨ç‰©åŒ–æ´¾ç”Ÿè¡¨çš„æ–¹å¼æ¥æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œæ—¶é¦–å…ˆä¼šåˆ°t1è¡¨ä¸­æ‰¾å‡ºæ»¡è¶³t1.a = 10çš„è®°å½•ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯´æ˜å‚ä¸è¿æ¥çš„t1è¡¨è®°å½•å°±æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ•´ä¸ªæŸ¥è¯¢çš„ç»“æœé›†å°±æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰å¿…è¦å»ç‰©åŒ–æŸ¥è¯¢ä¸­çš„æ´¾ç”Ÿè¡¨äº†

### å°†æ´¾ç”Ÿè¡¨å’Œå¤–å±‚çš„è¡¨åˆå¹¶

ä¹Ÿå°±æ˜¯å°†æŸ¥è¯¢é‡å†™ä¸ºæ²¡æœ‰æ´¾ç”Ÿè¡¨çš„å½¢å¼ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªsqlï¼š

````sql
mysql> select * from (select * from t1 where a = 1) as t;
````

å’Œä¸‹é¢çš„sqlæ˜¯ç­‰ä»·çš„ï¼š

````sql
select * from t1 where a = 1;
````

å†çœ‹ä¸€äº›å¤æ‚ä¸€ç‚¹çš„sqlï¼š

````sql
mysql> select * from (select * from t1 where a = 1) as t inner join t2 on t.a = t2.a
where t2.b = 1;
````

æˆ‘ä»¬å¯ä»¥å°†æ´¾ç”Ÿè¡¨ä¸å¤–å±‚æŸ¥è¯¢çš„è¡¨åˆå¹¶ï¼Œç„¶åå°†æ´¾ç”Ÿè¡¨ä¸­çš„æœç´¢æ¡ä»¶æ”¾åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ä¸­ï¼Œå°±åƒä¸‹é¢è¿™ æ ·ï¼š

````sql
mysql> select * from t1 inner join t2 on t1.a = t2.a where t1.a = 1 and t2.b = 1;
````

è¿™æ ·é€šè¿‡å°†å¤–å±‚æŸ¥è¯¢å’Œæ´¾ç”Ÿè¡¨åˆå¹¶çš„æ–¹å¼æˆåŠŸçš„æ¶ˆé™¤äº†æ´¾ç”Ÿè¡¨ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬æ²¡å¿…è¦å†ä»˜å‡ºåˆ›å»ºå’Œè®¿é—®ä¸´æ—¶è¡¨ çš„æˆæœ¬äº†ã€‚å¯æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰å¸¦æœ‰æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢éƒ½èƒ½è¢«æˆåŠŸçš„å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶ï¼Œå½“æ´¾ç”Ÿè¡¨ä¸­æœ‰è¿™äº›è¯­å¥å°±ä¸å¯ä»¥å’Œ å¤–å±‚æŸ¥è¯¢åˆå¹¶ï¼š

+ èšé›†å‡½æ•°ï¼Œæ¯”å¦‚MAX()ã€MIN()ã€SUM()å•¥çš„
+ DISTINCT
+ GROUP BY
+ HAVING
+ LIMIT
+ UNION æˆ–è€… UNION ALL
+ æ´¾ç”Ÿè¡¨å¯¹åº”çš„å­æŸ¥è¯¢çš„SELECTå­å¥ä¸­å«æœ‰å¦ä¸€ä¸ªå­æŸ¥è¯¢

> **æ‰€ä»¥MySQLåœ¨æ‰§è¡Œå¸¦æœ‰æ´¾ç”Ÿè¡¨çš„æ—¶å€™ï¼Œä¼˜å…ˆå°è¯•æŠŠæ´¾ç”Ÿè¡¨å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶æ‰ï¼Œå¦‚æœä¸è¡Œçš„è¯ï¼Œå†æŠŠæ´¾ç”Ÿè¡¨ç‰© åŒ–æ‰æ‰§è¡ŒæŸ¥è¯¢ã€‚**

## å¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µ

1. SQLè¯­å¥ä¸­INåŒ…å«çš„å€¼ä¸åº”è¿‡å¤šï¼Œä¸èƒ½è¶…è¿‡200ä¸ªï¼Œ200ä¸ªä»¥å†…æŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—æˆæœ¬æ—¶æ¯”è¾ƒç²¾å‡†ï¼Œè¶…è¿‡äº†200ä¸ªæ˜¯ä¼°ç®—çš„æˆæœ¬ï¼Œå¦å¤–å»ºè®®èƒ½ç”¨betweenå°±ä¸è¦ç”¨inï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨rangeç´¢å¼•äº†ã€‚

2. selectè¯­å¥åŠ¡å¿…æŒ‡æ˜å­—æ®µåç§°ï¼šselect * from å¢åŠ å¾ˆå¤šä¸å¿…è¦çš„æ¶ˆè€—(cpuã€ioã€å†…å­˜ã€ç½‘ç»œå¸¦å®½)ï¼›**å¢åŠ äº†ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„å¯èƒ½æ€§**ï¼›å½“è¡¨ç»“æ„å‘ç”Ÿæ”¹å˜æ˜¯ï¼Œå‰ç«¯ä¹Ÿéœ€è¦æ›´æ–°ã€‚æ‰€ä»¥è¦æ±‚ç›´æ¥åœ¨Selectåé¢æ¥ä¸Šå­—æ®µåã€‚

3. å½“åªéœ€è¦ä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œä½¿ç”¨limit 1

4. æ’åºæ˜¯æ³¨æ„æ˜¯å¦èƒ½ç”¨åˆ°ç´¢å¼•

5. ä½¿ç”¨oræ—¶å¦‚æœæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œå¯ä»¥æ”¹ä¸ºunion all æˆ–è€…union

6. å¦‚æœinä¸èƒ½ç”¨åˆ°ç´¢å¼•ï¼Œå¯ä»¥æ”¹æˆexistsçœ‹æ˜¯å¦èƒ½ç”¨åˆ°ç´¢å¼•

7. ä½¿ç”¨åˆç†çš„åˆ†é¡µæ–¹å¼ä»¥æé«˜åˆ†é¡µçš„æ•ˆç‡

   ```sql
   select a from t1 limit 10000, 1; -- è¿™ç§ä¸åˆç†ï¼Œç›¸å½“äºä»é“¾è¡¨ä¸­æ•°åˆ°ç¬¬10000çš„ä½ç½®
   select a from t1 where a >= 10000 limit 1 -- å¯ä»¥ä¼˜åŒ–æˆè¿™æ ·
   ```

   

8. ä¸å»ºè®®ä½¿ç”¨%å‰ç¼€æ¨¡ç³ŠæŸ¥è¯¢

9. é¿å…åœ¨whereå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œ

10. é¿å…éšå¼ç±»å‹è½¬æ¢

    ä»€ä¹ˆæ˜¯éšå¼è½¬æ¢ï¼š

    ```sql
    mysql> select '55'+ 'a';
    +-----------+
    | '55'+ 'a' |
    +-----------+
    |        55 |
    +-----------+
    ```

    ä¸ºä»€ä¹ˆç»“æœæ˜¯55å‘¢ï¼Ÿå› ä¸ºåŠ æ³•åªé’ˆå¯¹æ•°å­—ã€‚å¦‚æœçœŸçš„è¦åˆå¹¶å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

    ````sql
    mysql> select concat('55', 'a');
    +-------------------+
    | concat('55', 'a') |
    +-------------------+
    | 55a               |
    +-------------------+
    1 row in set (0.00 sec)
    ````

    å¦‚æœæƒ³ç”¨åŠ æ³•ï¼Œä¼šæŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•°å­—ï¼Œaä¼šè½¬æ¢æˆdoubleç±»å‹ï¼Œè¿™é‡Œå°±æ˜¯0ï¼Œè€Œ55æœ¬æ¥å°±æ˜¯55ã€‚

    æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªsqlï¼š

    ````sql
    mysql> select * from t1 where a > 'abc';
    +---+------+------+------+------+
    | a | b    | c    | d    | e    |
    +---+------+------+------+------+
    | 1 |    1 |    1 |    1 | a    |
    | 2 |    2 |    2 |    2 | b    |
    | 3 |    3 |    2 |    2 | c    |
    | 4 |    3 |    1 |    1 | d    |
    | 5 |    2 |    3 |    5 | e    |
    | 6 |    6 |    4 |    4 | f    |
    | 7 |    4 |    5 |    5 | g    |
    | 8 |    8 |    8 |    8 | h    |
    +---+------+------+------+------+
    8 rows in set, 2 warnings (0.00 sec)
    ````

    mysqlä¼šæŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•°å­—0ã€‚è¿™å°±æ˜¯å­—ç¬¦ä¸²è½¬æ¢æˆæ•°å­—çš„ä¾‹å­ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹æ•°å­—è½¬æ¢æˆå­—ç¬¦ä¸²çš„ä¾‹å­ï¼š

    ````sql
    mysql> explain select * from t1 where e = 1;
    +----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
    | id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
    +----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
    |  1 | SIMPLE      | t1    | NULL       | ALL  | idx_t1_e      | NULL | NULL    | NULL |    8 |    12.50 | Using where |
    +----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
    1 row in set, 3 warnings (0.00 sec)
    ````

    é€šè¿‡ä¸Šé¢çš„sqlæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œæˆ‘ä»¬å·²ç»æå‰ç»™eå­—æ®µåŠ ä¸Šäº†ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆè¿™å„¿æ²¡æœ‰ç”¨åˆ°å‘¢ï¼Ÿè¿™å°±æ˜¯éšå¼è½¬æ¢ï¼Œå› ä¸ºeæ˜¯`varchar`ç±»å‹çš„ã€‚åªæœ‰æŠŠæ¡ä»¶æ¢æˆ'1'æ‰è¡Œ

    

11. å¯¹äºè”åˆç´¢å¼•æ¥è¯´ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™

12. å¿…è¦æ—¶å¯ä»¥ä½¿ç”¨force indexæ¥å¼ºåˆ¶æŸ¥è¯¢èµ°æŸä¸ªç´¢å¼•

13. å¯¹äºè”åˆç´¢å¼•æ¥è¯´ï¼Œå¦‚æœå­˜åœ¨èŒƒå›´æŸ¥è¯¢ï¼Œæ¯”å¦‚between,>,<ç­‰æ¡ä»¶æ—¶ï¼Œä¼šé€ æˆåé¢çš„ç´¢å¼•å­—æ®µå¤±æ•ˆã€‚

14. å°½é‡ä½¿ç”¨inner joinï¼Œé¿å…left joinï¼Œè®©æŸ¥è¯¢ä¼˜åŒ–å™¨æ¥è‡ªåŠ¨é€‰æ‹©å°è¡¨ä½œä¸ºé©±åŠ¨è¡¨

15. å¿…è¦æ—¶åˆ»å¯ä»¥ä½¿ç”¨straight_joinæ¥æŒ‡å®šé©±åŠ¨è¡¨ï¼Œå‰ææ¡ä»¶æ˜¯æœ¬èº«æ˜¯inner join

## æ€»ç»“

1. æŸ¥è¯¢ä¼˜åŒ–å™¨
   1. å…¨è¡¨æ‰«æï¼šä¼°è®¡å…¨è¡¨æœ‰å¤šå°‘é¡µ+ä¼°è®¡å…¨è¡¨æœ‰å¤šå°‘è¡Œ
   2. ç´¢å¼•æ‰«æ
      1. ä¸»é”®ç´¢å¼•ï¼šèŒƒå›´åŒºé—´ä¸ªæ•° + ä¼°ç®—å„ä¸ªèŒƒå›´åŒºé—´æœ‰å¤šå°‘è¡Œ(in()åé¢çš„å‚æ•°å¦‚æœå°äº200ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨æ¯”è¾ƒç²¾ç¡®çš„æ–¹å¼å»ä¼°ç®—è¡Œæ•°ï¼Œå¦åˆ™å»ç»Ÿè®¡å€¼)
      2. è¾…åŠ©ç´¢å¼•ï¼šè¾…åŠ©ç´¢å¼•æ‰«æ + å›è¡¨æˆæœ¬
   3. æ•°æ®ç»Ÿè®¡
      1. å¼‚æ­¥ç»Ÿè®¡
      2. analyze table
2. JOIN
   1. åŸç†
      1. Block Nested-Loop Join
      2. JOIN buffer
      3. å°è¡¨é©±åŠ¨å¤§è¡¨
   2. ä¼˜åŒ–åŸåˆ™
      1. å¢å¤§JOIN BUFFER
      2. å¤–è¿æ¥æ¶ˆé™¤(è½¬åŒ–æˆå†…è¿æ¥ï¼Œä½¿å¾—å¯ä»¥åˆ©ç”¨æŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©å°è¡¨é©±åŠ¨å¤§è¡¨)
3. å­æŸ¥è¯¢ä¼˜åŒ–
   1. INå­æŸ¥è¯¢åŸç†
      1. ç‰©åŒ–è¡¨
      2. semi join(ç›¸å…³å­æŸ¥è¯¢ä¸èƒ½è½¬åŒ–æˆç‰©åŒ–è¡¨)
         1. table pulloutï¼ˆç›´æ¥å°†inè¯­å¥æ”¹ä¸ºjoinï¼‰
         2. DuplicateWeedout:åˆ©ç”¨ä¸»é”®å»é‡
         3. FirstMatchï¼šé€»è¾‘ä¸Šçš„å»é‡
         4. LosseScanï¼šåˆ©ç”¨ç´¢å¼•å»é‡