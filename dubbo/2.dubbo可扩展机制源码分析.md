# Dubboçš„å¯æ‰©å±•æœºåˆ¶æºç åˆ†æ

![page1image33620176.png](./img/7.png) 

æ³¨æ„ï¼š

åœ¨dubboæ¶ˆè´¹è€…ç«¯è°ƒç”¨æœåŠ¡æä¾›è€…çš„æœåŠ¡çš„æ—¶å€™æ‹¿åˆ°å®ç°ç±»æ˜¯**ä»£ç†ç±»**ï¼Œéœ€è¦æ„é€ invokerå¯¹è±¡å†æ‹¿åˆ°æ–¹æ³•ã€‚

## Java SPI

JDKæ ‡å‡†çš„SPIä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•ç‚¹æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰æ‰©å±•å®ç°åˆå§‹åŒ–å¾ˆè€—æ—¶ï¼Œä½†å¦‚æœæ²¡ç”¨ä¸Šä¹ŸåŠ è½½ï¼Œä¼šå¾ˆæµªè´¹èµ„æºã€‚

1. æ¯”å¦‚ä¸€ä¸ªæ¡†æ¶æœ‰ä¸€ä¸ªjaråŒ…ï¼Œæœ‰ä¸€ä¸ªinterfaceçš„æ¥å£ï¼Œå¦‚æœç°åœ¨æƒ³å¾€è¿™ä¸ªæ¡†æ¶é‡Œé¢æ·»åŠ ä¸€ä¸ªå®ç°ç±»

2. è‡ªå·±å†™çš„ä»£ç é‡Œé¢å»å®ç°è¿™ä¸ªæ¥å£ï¼ŒæŠŠå®ç°ç±»å®šä¹‰åœ¨`MATA-INF.service`å¯¹åº”çš„æ¥å£æ–‡ä»¶é‡Œé¢(SPI)ï¼Œæœ€åæ‰“æˆjaråŒ…

3. ç°åœ¨å°±å¯ä»¥æŠŠæ¡†æ¶çš„jaråŒ…å’Œæˆ‘ä»¬è‡ªå·±å†™çš„jaråŒ…æ”¾åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®é‡Œé¢ï¼Œå¦‚æœæ¡†æ¶æ˜¯é€šè¿‡SPIçš„æ–¹å¼å»å®ç°çš„ï¼Œå°±å¯ä»¥åŠ è½½æˆ‘ä»¬è‡ªå·±çš„å®ç°äº†ç±» 


å†æ¥æ‰“ä¸ªæ¯”æ–¹ï¼š

1. æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæœ‰ä¸€ä¸ªinterfaceï¼Œè‡ªå·±æœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±»
2. è¿™ä¸ªinterfaceè¶Šæ¥è¶Šç«ï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹å…¬å¸éƒ½åœ¨ç”¨ï¼Œå¼€æºäº†ï¼Œå¾ˆå¤šçš„äººæˆ–è€…ç»„ç»‡è§‰å¾—å¥½ï¼Œå°±æƒ³å»æ‰©å±•å®ƒï¼Œç»§è€Œæœ‰è‡ªå·±çš„ä¸€ä¸ªå®ç°ç±»
3. ç°åœ¨æˆ‘å°±åœ¨æƒ³ï¼Œæˆ‘å†ç”¨åˆ°ä½ è¿™ä¸ªæ¡†æ¶çš„æ—¶å€™æ€ä¹ˆèƒ½ç”¨åˆ°æˆ‘è‡ªå·±å†™çš„å®ç°ç±»ï¼Ÿ
4. è¿˜æ˜¯é€šè¿‡SPIçš„æ–¹å¼æŠŠå®ç°ç±»å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢æ”¾åœ¨classpathä¸‹é¢
5. å¦‚æœæˆ‘ä»¬é¡¹ç›®æƒ³ç”¨è¿™äº›ç¬¬ä¸‰æ–¹çš„å®ç°ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–ä»¬æ‰“æˆä¸€ä¸ªjaråŒ…æ”¾åœ¨æˆ‘ä»¬çš„é¡¹ç›®é‡Œé¢
6. é€šè¿‡`serviceLoad`çš„æ–¹å¼è°ƒç”¨å³å¯

å¼Šç«¯ï¼š

1. å…¨éƒ¨åŠ è½½ï¼Œè€—è´¹èµ„æº

å…·ä½“ä»£ç ï¼š

0. åˆ›å»ºæµ‹è¯•æ¥å£`CarInterface`ä»¥åŠå‡ ä¸ªå®ç°ç±»ï¼š

   ````java
   @SPI
   public interface CarInterface {
       // è·å¾—é¢œè‰²
       public void getColor();
   
   }
   ````

   ````java
   public class BlackCar implements CarInterface {
       @Override
       public void getColor() {
           System.out.println("black");
       }
   }
   ````

   ````java
   public class RedCar implements CarInterface {
       @Override
       public void getColor() {
           System.out.println("red");
       }
   }
   ````

1. åœ¨`resources`ç›®å½•ä¸‹åˆ›å»º`MATE-INF/services`ç›®å½•

2. åœ¨å…¶ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå°†è‡ªå·±å®šä¹‰çš„æ¥å£çš„å…¨è·¯å¾„ä½œä¸ºæ–‡ä»¶åå­—ï¼Œå¦‚å›¾ï¼š

   ![](./img/8.jpg)

3. åœ¨æ–‡ä»¶é‡Œé¢ä¸€è¡Œä¸€è¡Œå†™å‡ºå®ç°ç±»çš„å…¨è·¯å¾„

   ````
   com.test.BlackCar
   com.test.RedCar
   ````

4. é€šè¿‡APIè°ƒç”¨

   ````java
   public static void main(String[] args) {
     ServiceLoader<CarInterface> serviceLoader = ServiceLoader.load(CarInterface.class);
     Iterator<CarInterface> iterator = serviceLoader.iterator();
     while (iterator.hasNext()) {
       CarInterface carInterface = iterator.next();
       carInterface.getColor();
     }
   }
   ````
   

ç»“æœï¼š

````java
   black
   red
````

**éœ€è¦å¯¹è¢«æ‰©å±•çš„æ¥å£ä¸ŠåŠ ä¸Š`@SPI`çš„æ³¨è§£**

## Dubbo SPIô°£ô°¤ô°¤ô°¥ ô³€ô²¿ô²³ô°¢ô°£ô°¤ô°¤ô°¥ ô³€ô²¿ô²³

ä¸Šé¢è¯´é“JDK SPIè€—è´¹èµ„æºï¼Œè€ŒDubboå¯¹JDK SPIè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸å†æ˜¯å¯¹èµ„æºå…¨éƒ¨åŠ è½½ï¼Œè€Œæ˜¯é€šè¿‡key/valueçš„å½¢å¼æ¥è¿›è¡ŒåŠ è½½ã€‚

1. å°†å¯¹åº”æ–‡ä»¶é‡Œé¢çš„å®ç°ç±»ä¿®æ”¹ä¸ºkey/valueçš„å½¢å¼

   ````
   black = com.test.BlackCar
   red = com.test.RedCar
   ````

2. ç„¶åAPIé€šè¿‡getè·å–ï¼Œå¦‚ä¸‹ï¼š

3. ````java
   public static void main(String[] args) {
     ExtensionLoader<CarInterface> extensionLoader =
       													ExtensionLoader.getExtensionLoader(CarInterface.class);
     CarInterface carInterface = extensionLoader.getExtension("black");
     carInterface.getColor();
   }
   ````

   ````
   black
   ````

4. **Dubboè‡ªåŠ¨åŒ…è£…**

   1. æ–°å»ºä¸€ä¸ªwrapperç±»

      ````java
      public class CarWrapper implements CarInterface{
      
          private CarInterface carInterface;
      
          public CarWrapper(CarInterface carInterface) {
              this.carInterface = carInterface;
          }
      
          @Override
          public void getColor() {
              System.out.println("before");
              carInterface.getColor();
              System.out.println("after");
          }
      }
      
      ````

   2. å°†wrapperç±»åŠ å…¥åˆ°SPIçš„é…ç½®æ–‡ä»¶å½“ä¸­

      ```
      black = com.test.BlackCar
      red = com.test.RedCar
      com.test.CarWrapper
      ```

   3. æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼Œå¯¹æ–¹æ³•è¿›è¡Œäº†å¢å¼º

      ````java
      before
      black
      after
      ````

   4. ä¹Ÿå¯ä»¥è¿›è¡Œå±‚å±‚çš„å¢å¼ºï¼Œæ¯”å¦‚å†æ–°å¢ä¸€ä¸ªwarpperç±»

      ````java
      public class CarWrapper2 implements CarInterface {
      
          private CarInterface carInterface;
      
          public CarWrapper2(CarInterface carInterface) {
              this.carInterface = carInterface;
          }
      
          @Override
          public void getColor() {
              System.out.println("before2");
              carInterface.getColor();
              System.out.println("after2");
          }
      }
      ````

   5. å†å°†è¿™ä¸ªç±»åŠ å…¥åˆ°SPIçš„é…ç½®æ–‡ä»¶å½“ä¸­å»ï¼Œå°±æ”¾åœ¨ç¬¬ä¸€ä¸ªwrapperç±»çš„ä¸‹é¢

      ````
      black = com.test.BlackCar
      red = com.test.RedCar
      com.test.CarWrapper
      com.test.CarWrapper2
      ````

   6. ç»“æœ

      ````
      before
      before2
      black
      after2
      after
      ````

      åŒæ ·å¯¹æ–¹æ³•è¿›è¡Œäº†å¢å¼ºã€‚è¿™ç‚¹ç±»ä¼¼äº**é™æ€ä»£ç†**ï¼Œä¸è¿‡å®ƒèƒ½ä¸€å±‚ä¸€å±‚ä¸åœåœ°çš„åŒ…è£¹ï¼Œè€Œä¸”æ˜¯**SPIçš„é…ç½®è¶Šé åï¼Œè¶Šå…ˆæ‰§è¡Œ**ï¼Œè¿™å°±åƒæäº†Springé‡Œé¢çš„AOP

5. **Dubboè‡ªåŠ¨æ³¨å…¥**

   **åœ¨dubboé‡Œé¢æ˜¯ä¾èµ–URLæ¥è¿›è¡Œè‡ªåŠ¨æ³¨å…¥çš„**

   1. åœ¨åŸæ¥çš„æ¥å£ä¸Šæ–°å¢ä¸€ä¸ªæ–¹æ³•ï¼Œæ·»åŠ `@Adaptive`

      ````java
      @SPI
      public interface CarInterface {
          // è·å¾—é¢œè‰²
          public void getColor();
          @Adaptive(value = "car")
          public void getColorURL(URL url);
      }
      ````

   2. æ–°å¢ä¸€ä¸ªç±»

      ````java
      public class BenzCar implements CarInterface{
      
          private CarInterface carInterface;
      
          // æ³¨å…¥ç‚¹
          public void setCarInterface(CarInterface carInterface) {
              this.carInterface = carInterface;
          }
      
          @Override
          public void getColor() {
      
              System.out.println("Benz Car");
          }
      		
          @Override
          public void getColorURL(URL url) {
              System.out.println("do Something~");
              carInterface.getColorURL(url);
          }
      }
      ````

      ````
      black = com.test.BlackCar
      red = com.test.RedCar
      benz = com.test.BenzCar
      # com.test.CarWrapper
      # com.test.CarWrapper2
      ````

   3. æµ‹è¯•

      ä¹‹å‰çš„å®ç°ç±»éƒ½ç›¸ç»§åŠ ä¸Šäº†æ–°çš„æ–¹æ³•
   
      ````java
      public class RedCar implements CarInterface {
          @Override
          public void getColor() {
              System.out.println("red");
          }
      
          @Override
          public void getColorURL(URL url) {
              System.out.println("red url");
          }
   }
      ````
   
      ````java
      ExtensionLoader<CarInterface> extensionLoader =
                      ExtensionLoader.getExtensionLoader(CarInterface.class);
      CarInterface carInterface = extensionLoader.getExtension("benz");
      Map<String, String> map = new HashMap<>();
      map.put("car", "red");
      URL url = new URL("", "", 1, map);
   carInterface.getColorURL(url);
      ````

   4. ç»“æœ
   
      ```
      do Something~
   red url
      ```

   5. ç»“è®º
   
      å…¶å®å°±æ˜¯ä»URLä¸­çš„Mapä¸­è·å–æˆ‘ä»¬å®šä¹‰å¥½çš„carå¼€å¤´çš„æœåŠ¡(`@Adaptive(value = "car")`)ï¼Œè¿™å„¿æ‹¿åˆ°çš„æ˜¯å®ç°ç±»`RedCar`ï¼Œ**å…¶å®åŠ äº†`@Adaptive`æ³¨è§£çš„æ–¹æ³•ï¼Œä¼šåœ¨ç”Ÿæˆçš„æ—¶å€™è¢«dubboåˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œæ–¹æ³•ä¹Ÿä¼šè¢«è¿›è¡Œå¢å¼ºï¼Œå…¶å®å°±æ˜¯æ·»åŠ äº†ä»URLä¸­è·å–é…ç½®çš„å®ç°ç±»çš„ä»£ç æ¥å®ç°çš„**

## Dubbo SPI æºç åˆ†æ

1. ä»`ExtensionLoader.getExtensionLoader(CarInterface.class)`çœ‹èµ·

   ````java
   public static <T> ExtensionLoader<T> getExtensionLoader(Class<T> type) {
     if (type == null) {
       throw new IllegalArgumentException("Extension type == null");
     }
     if (!type.isInterface()) {
       throw new IllegalArgumentException("Extension type (" + type + ") is not an interface!");
     }
     if (!withExtensionAnnotation(type)) {
       throw new IllegalArgumentException("Extension type (" + type +
                                          ") is not an extension, because it is NOT annotated with @" + SPI.class.getSimpleName() + "!");
     }
     // EXTENSION_LOADERSæ˜¯ä¸€ä¸ªCurrentHashMap
     ExtensionLoader<T> loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);
     if (loader == null) {
       // è¿™ç‚¹ä»£ç çš„åŠŸèƒ½ç›¸å½“äºç¼“å­˜åˆ°æœ¬åœ°
       // new ExtensionLoaderçš„æ—¶å€™å…¶å®æœ‰æŠŠè¢«æ‰©å±•çš„æ¥å£åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå¦‚æœæ–¹æ³•æœ‰åŠ @Adaptiveæ³¨è§£
       // å°±ä¼šè¢«å¢å¼ºï¼Œæ·»åŠ URLè·å–å±æ€§çš„å®ç°ç±»çš„æ–¹å¼
       EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader<T>(type));
       loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);
     }
     return loader;
   }
   ````

   **ä¸€ä¸ªæ¥å£å¯¹åº”ä¸€ä¸ªExtensionLoaderï¼ŒåŒæ—¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚**

2. å…·ä½“çœ‹`extensionLoader.getExtension("benz");`æ–¹æ³•

   ````java
   public T getExtension(String name) {
     if (StringUtils.isEmpty(name)) {
       throw new IllegalArgumentException("Extension name == null");
     }
     if ("true".equals(name)) {
       // è¿”å›é»˜è®¤çš„
       return getDefaultExtension();
     }
     /**
       * holderå°±æ˜¯ä¿å­˜æ•°æ®çš„å°è£…ç±»ï¼Œå°±æ˜¯ä¸ºäº†æ–¹ä¾¿è·å–ï¼Œç±»ä¼¼äºSpringé‡Œé¢çš„é‚£ä¸ªBeanDefinitionHolder
       * Holder<Object> holder = cachedInstances.get(name); 
       	ConcurrentMap<String, Holder<Object>> cachedInstances = new ConcurrentHashMap<>();
       	cachedInstancesåº”è¯¥æ˜¯å­˜å‚¨ç¼“å­˜çš„å¯¹è±¡
       */
     Holder<Object> holder = getOrCreateHolder(name);
     Object instance = holder.get();
     if (instance == null) {
       synchronized (holder) {
         instance = holder.get();
         if (instance == null) {
           instance = createExtension(name); // æ‰©å±•ç‚¹ï¼Œå®ç°ç±»
           holder.set(instance);
         }
       }
     }
     return (T) instance;
   }
   ````

   ````java
   public class Holder<T> {
   
       private volatile T value;
   
       public void set(T value) {
           this.value = value;
       }
   
       public T get() {
           return value;
       }
   
   }
   ````

   å¯è§ï¼Œå…³é”®ç‚¹è¿˜æ˜¯`createExtension()`æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•æ— éæ˜¯ä½œä¸ºç¼“å­˜ä¹‹ç”¨çš„ã€‚

3. `instance = createExtension(name);`

   ````java
   private T createExtension(String name) {
   		// è·å–
       Class<?> clazz = getExtensionClasses().get(name);
       if (clazz == null) {
         throw findException(name);
       }
       try {
         T instance = (T) EXTENSION_INSTANCES.get(clazz);
         if (instance == null) {
           EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());
           instance = (T) EXTENSION_INSTANCES.get(clazz);
         }
         injectExtension(instance);
         Set<Class<?>> wrapperClasses = cachedWrapperClasses;
         if (CollectionUtils.isNotEmpty(wrapperClasses)) {
           for (Class<?> wrapperClass : wrapperClasses) {
             instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));
           }
         }
         return instance;
       } catch (Throwable t) {
         throw new IllegalStateException("Extension instance (name: " + name + ", class: " +
                                         type + ") couldn't be instantiated: " + t.getMessage(), t);
       }
     }
   ````

   æˆ‘ä»¬å…ˆæ¥çœ‹`getExtensionClasses()`æ–¹æ³•ï¼Œä½†æ˜¯å®ƒçš„è°ƒç”¨é“¾æ¯”è¾ƒé•¿ï¼Œè¿™å„¿å°±ä¸è´´ä»£ç äº†ï¼Œç®€å•æ€»ç»“ä¸‹ï¼Œå°±æ˜¯ï¼š

   1. è¯»å–SPIé…ç½®æ–‡ä»¶ä¸­çš„ä¸€è¡Œä¸€è¡Œçš„æ•°æ®ï¼Œå°†å®ç°ç±»ç¼“å­˜åœ¨ä¸€ä¸ªmapé‡Œé¢
   2. åœ¨è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰åŠ äº†`@Adapitive`æ³¨è§£çš„ä¹Ÿç¼“å­˜åœ¨ä¸€ä¸ªvalotileå˜é‡é‡Œ
   3. å¦‚æœå®ç°ç±»çš„æ„é€ æ–¹æ³•å‚æ•°ç±»å‹å’Œè¢«æ‰©å±•æ¥å£ç±»å‹ä¸€æ ·å°±åˆ¤æ–­ä¸º`wrapper`ç±»ï¼Œç„¶åç¼“å­˜ä¸€ä¸ªhashseté‡Œé¢
   4. è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨é“¾é‡Œé¢è¿˜æœ‰ä¸€äº›å°å°çš„éªŒè¯

   ä»£ç ç»§ç»­æ‰§è¡Œ

4. `injectExtension`

   ````java
   private T injectExtension(T instance) {
     try {
       // è¿™ä¸ªobjectFactoryåœ¨new Extensionloaderçš„æ—¶å€™è°ƒç”¨çš„
       // objectFactoryæ˜¯è¿™ä¸ªExtensionFactoryçš„ä»£ç†ç±»ä¹Ÿå°±æ˜¯AdaptiveExtensionFactoryï¼Œä½†æ˜¯å®ƒä¼šè¯»å–SPIé…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åç”Ÿæˆæ‰©å±•æ¥å£çš„ä»£ç†ç±»ï¼Œå…¶ä¸­é€»è¾‘å¦‚ä¸‹
       // 1.å®ƒä¼šå…ˆè¯»å–é…ç½®æ–‡ä»¶æ‰¾åˆ°æ‰€æœ‰çš„å®ç°ç±»ï¼Œ å¦‚æœæœ‰å®ç°ç±»åŠ äº†@Adaptiveæ³¨è§£çš„å°±æŠŠè¿™ä¸ªç±»å½“åšè¯¥æ¥å£çš„ä»£ç†ç±»
       // 2.å¦‚æœæ²¡æœ‰åŠ äº†@Adaptiveæ³¨è§£çš„å®ç°ç±»ï¼ŒDubboå°±ç»™ä½ åˆ›å»ºä¸€ä¸ªï¼Œè¿™ä¸ªç±»ä¹Ÿå®ç°äº†è¿™ä¸ªæ¥å£ï¼Œç±»åä¸­æœ‰$Adaptiveè¿™ä¸ªå­—ç¬¦ä¸²
       if (objectFactory != null) {
         for (Method method : instance.getClass().getMethods()) {
           // å¦‚æœæ˜¯setteræ–¹æ³•
           if (isSetter(method)) {
             /**
                            * Check {@link DisableInject} to see if we need auto injection for this property
                            */
             if (method.getAnnotation(DisableInject.class) != null) {
               continue;
             }
             // ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹
             Class<?> pt = method.getParameterTypes()[0];
             if (ReflectUtils.isPrimitives(pt)) {
               continue;
             }
             try {
               // é€šè¿‡æ–¹æ³•è·å–å®ç°ç±»çš„å±æ€§ setCarInterface() -> carInterface
               String property = getSetterProperty(method);
               // ptæ˜¯è¢«æ‰©å±•çš„æ¥å£ com.test.CarInterface
               // objectå°±æ˜¯ptè¢«ä»£ç†çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ³¨å…¥çš„å¯¹è±¡
               // 1.objectFactoryæ˜¯AdaptiveExtensionFactoryï¼Œä¸Šé¢åˆ†æäº†
               // 2.AdaptiveExtensionFactoryé‡Œé¢çš„getExtensionæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„å¦ä¸€ä¸ªå®ç°ç±»SpiExtensionFactoryçš„getExtensionæ–¹æ³•
               // 3.SpiExtensionFactoryçš„getExtensionæ–¹æ³•å»æ‰¾ptçš„ä»£ç†ç±»ï¼Œç„¶åè¿”å›ï¼Œå°±æ˜¯ç°åœ¨çš„object
               // 4.SpiExtensionFactoryçš„getExtensionæ²¡æœ‰ç”¨åˆ°propertyï¼Œè€Œå…¶çˆ¶ç±»çš„å¦ä¸€ä¸ªç±»SpringExtensionFactoryå°±ä¼šä½¿ç”¨åˆ°
               // 5.å› ä¸ºç°åœ¨æ²¡æœ‰ç”¨åˆ°Springï¼Œæ‰€ä»¥SpiExtensionFactoryæ²¡æœ‰ç”¨
               // 6.æ‰€ä»¥æ— è®ºæ€ä¹ˆè¯´ï¼Œobjectå°±æ˜¯ptçš„ä»£ç†å¯¹è±¡
               // 7.æ‰€ä»¥æœ€ç»ˆæ‰§è¡Œæ‰©å±•æ¥å£çš„æ–¹æ³•ï¼Œå°±æ˜¯æ‰§è¡Œæ‰©å±•æ¥å£çš„ä»£ç†å¯¹è±¡å¯¹åº”çš„æ–¹æ³•
               // 8.è¿™å°±æ˜¯æ³¨å…¥
               Object object = objectFactory.getExtension(pt, property);
               if (object != null) {
                 // æ‰§è¡Œsetæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼
                 method.invoke(instance, object);
               }
             } catch (Exception e) {
               logger.error("Failed to inject via method " + method.getName()
                            + " of interface " + type.getName() + ": " + e.getMessage(), e);
             }
           }
         }
       }
     } catch (Exception e) {
       logger.error(e.getMessage(), e);
     }
     return instance;
   }
   ````

   ä¸Šé¢çš„`objectFactory`å˜é‡å¦‚ä¸‹

   ```java
   ExtensionLoader<CarInterface> extensionLoader =
           ExtensionLoader.getExtensionLoader(CarInterface.class);
   ```

   åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢åˆ›å»ºçš„

   ````java
   objectFactory =
     (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());
   ````

   **`objectFactory`æ˜¯`ExtensionFactory`çš„ä»£ç†ç±»ï¼Œå…¶å®å°±æ˜¯`getAdaptiveExtension()`æ–¹æ³•ä¼šæŠŠæˆ‘ä»¬çš„æ‰©å±•æ¥å£ç”Ÿæˆä»£ç†ç±»ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š**

   1. è¯»å–SPIé…ç½®æ–‡ä»¶ï¼Œå¦‚æœé‡Œé¢å®ç°ç±»æœ‰`@Adaptive`æ³¨è§£çš„å°±æŠŠè¿™ä¸ªç±»å½“åšè¯¥æ¥å£çš„ä»£ç†ç±»

   2. å¦‚æœæ²¡æœ‰å°±å¸®ä½ åˆ›å»ºä¸€ä¸ªç±»åä»¥`$Adaptive`ç»“å°¾çš„ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š

      ![](./img/9.png)

   3. ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä»£ç†ç±»è¿˜æ˜¯å®ç°äº†æ¥å£ï¼Œæ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡Dubboçš„SPIå»æ‰§è¡Œï¼Œå¦‚æœæ¥å£æ–¹æ³•åŠ äº†`@Adaptive`æ³¨è§£ï¼Œé‚£ä¹ˆå°±ä¼šä»URLå»è·å–å¯¹åº”çš„å‚æ•°çš„å®ç°ç±»ï¼Œç„¶ååœ¨æ‰§è¡Œæ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„`getColor()`æ–¹æ³•ï¼Œå¦‚æœæ¥å£ä¸Šæ²¡æœ‰åŠ `@Adaptive`ï¼Œä»£ç†ç±»ä¸­å¯¹åº”çš„æ–¹æ³•å°±ä¼šåŠ ä¸Šä¸€æ®µè·‘å‡ºå¼‚å¸¸çš„å†…å®¹ï¼Œå¦‚ä¸Šå›¾çš„ä¸­çš„`getSize()`æ–¹æ³•ã€‚

   `ExtensionFactory`è¿™ä¸ªç±»ï¼Œæœ‰é»˜è®¤çš„å®ç°ç±»ï¼Œå¦‚ä¸‹ï¼Œå¯ä»¥è®¤ä¸ºè¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ª`ExtensionFactory`ä»£ç†å®ç°ç±»

   ````java
   public class AdaptiveExtensionFactory implements ExtensionFactory {
   
       private final List<ExtensionFactory> factories;
   
       public AdaptiveExtensionFactory() {
           ExtensionLoader<ExtensionFactory> loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);
           List<ExtensionFactory> list = new ArrayList<ExtensionFactory>();
           for (String name : loader.getSupportedExtensions()) {
               list.add(loader.getExtension(name));
           }
           factories = Collections.unmodifiableList(list);
       }
   
       @Override
       public <T> T getExtension(Class<T> type, String name) {
           for (ExtensionFactory factory : factories) {
               T extension = factory.getExtension(type, name);
               if (extension != null) {
                   return extension;
               }
           }
           return null;
       }
   
   }
   ````

   **æ‰€ä»¥`objectFactory`å°±æ˜¯è¿™ä¸ª`ExtensionFactory`çš„ä»£ç†ç±»`AdaptiveExtensionFactory`**

   `Object object = objectFactory.getExtension(pt, property);`

   è¿™æ®µä»£ç å¾ˆå¤æ‚ï¼Œä¸‹é¢æˆ‘æŠŠæ³¨é‡Šè´´å‡ºæ¥

   ````java
   // é€šè¿‡æ–¹æ³•è·å–å®ç°ç±»çš„å±æ€§ setCarInterface() -> carInterface
   String property = getSetterProperty(method);
   // ptæ˜¯è¢«æ‰©å±•çš„æ¥å£ com.test.CarInterface
   // objectå°±æ˜¯ptè¢«ä»£ç†çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ³¨å…¥çš„å¯¹è±¡
   // 1.objectFactoryæ˜¯AdaptiveExtensionFactoryï¼Œä¸Šé¢åˆ†æäº†
   // 2.AdaptiveExtensionFactoryé‡Œé¢çš„getExtensionæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„å¦ä¸€ä¸ªå®ç°ç±»SpiExtensionFactoryçš„getExtensionæ–¹æ³•
   // 3.SpiExtensionFactoryçš„getExtensionæ–¹æ³•å»æ‰¾ptçš„ä»£ç†ç±»ï¼Œç„¶åè¿”å›ï¼Œå°±æ˜¯ç°åœ¨çš„object
   // 4.SpiExtensionFactoryçš„getExtensionæ²¡æœ‰ç”¨åˆ°propertyï¼Œè€Œå…¶çˆ¶ç±»çš„å¦ä¸€ä¸ªç±»SpringExtensionFactoryå°±ä¼šä½¿ç”¨åˆ°
   // 5.å› ä¸ºç°åœ¨æ²¡æœ‰ç”¨åˆ°Springï¼Œæ‰€ä»¥SpiExtensionFactoryæ²¡æœ‰ç”¨
   // 6.æ‰€ä»¥æ— è®ºæ€ä¹ˆè¯´ï¼Œobjectå°±æ˜¯ptçš„ä»£ç†å¯¹è±¡
   // 7.æ‰€ä»¥æœ€ç»ˆæ‰§è¡Œæ‰©å±•æ¥å£çš„æ–¹æ³•ï¼Œå°±æ˜¯æ‰§è¡Œæ‰©å±•æ¥å£çš„ä»£ç†å¯¹è±¡çš„æ–¹æ³•
   // 8.è¿™å°±æ˜¯æ³¨å…¥
   Object object = objectFactory.getExtension(pt, property);
   if (object != null) {
     // æ‰§è¡Œsetæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼
     method.invoke(instance, object);
   }
   ````

   **å…¶å®æ³¨å…¥å°±æ˜¯å°†è¢«æ‰©å±•æ¥å£çš„ä»£ç†ç±»æ³¨å…¥åˆ°å®ç°ç±»é‡Œé¢ï¼Œå› ä¸ºè¢«æ‰©å±•æ¥å£çš„ä»£ç†ç±»çš„æ–¹æ³•åŠ äº†`@Adaptive`æ³¨è§£å°±ä¼šå»ä»URLä¸­è·å–`@Adaptive`çš„å€¼å¯¹åº”çš„å®ç°ç±»çš„keyï¼Œç„¶åé€šè¿‡SPIçš„æ–¹å¼å»é…ç½®æ–‡ä»¶ä¸­è·å–å¯¹åº”çš„å®ç°ç±»ï¼Œç„¶åå®ä¾‹åŒ–ï¼Œæ‰§è¡Œæ–¹æ³•ï¼Œè¿™æ ·å°±å®Œæˆäº†Dubboçš„è‡ªåŠ¨æ³¨å…¥**


## Dubbo API

### ô°«ô°¬ô°­URL

ç»Ÿä¸€èµ„æºå®šä½å™¨

### æ ‡å‡†çš„URLæ ¼å¼

`protocol://username:password@host:port/path?key=value&key=value`

 å‚æ•°å¯ä»¥ç†è§£ä¸ºä½¿ç”¨è¿™ä¸ªèµ„æºçš„å‚æ•°ï¼Œå…¶å®å°±æ˜¯é…ç½®ä¿¡æ¯

### Dubboä¸­çš„URL

åœ¨Dubboä¸­ï¼š

+ æœåŠ¡æ˜¯èµ„æºï¼Œdubbo://192.168.1.6:20880/com.luban.HelloService?timeout=3000
+ æ³¨å†Œä¸­å¿ƒæ˜¯èµ„æºï¼šzookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService? application=democonsumer&dubbo=2.0.2&interface=org.apache.dubbo.registry.RegistryService&pid=1214&qos.po rt=33333Ã—tamp=1545721981946
+ æ¶ˆè´¹è€…æ˜¯èµ„æºï¼šconsumer://30.5.120.217/org.apache.dubbo.demo.DemoService? application=demoA$I R1@DPJ(3   0/ -L   consumer&category=consumers&check=false&dubbo=2.0.2&interface=org.apache.dubbo.demo. DemoService&methods=sayHello&pid=1209&qos.port=33333&side=consumerÃ—tamp=1545 721827784
+ é…ç½®ä¿¡æ¯æ˜¯èµ„æº
+ å…ƒæ•°æ®ä¿¡æ¯æ˜¯èµ„æº
+ ä¸‡ç‰©çš†èµ„æºï¼Œçš†å¯ç”¨URLè¡¨ç¤ºô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†ô°€ô°ô°‚ô°ƒô°„ô°…ô°†

æˆ‘ä»¬ç”¨`<dubbo:service interface="com.luban.dubbo_vip_xml_demo.api.HelloService"
ref="helloService"/>`å®šä¹‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆspringä¼šæŠŠdubboçš„æ ‡ç­¾è§£ææˆBeanå¯¹è±¡ï¼Œåœ¨æœåŠ¡æš´éœ²åˆå§‹åŒ–æ—¶ï¼Œå°†Beanå¯¹è±¡è½¬æ¢URLæ ¼å¼ï¼Œæ‰€ä»¥Beanå±æ€§è½¬åŒ–æˆURLçš„å‚æ•°ã€‚

å¯¹äºdubboä¸­çš„URLï¼Œæœ‰äººç†è§£ä¸ºé…ç½®æ€»çº¿ï¼Œæœ‰äººç†è§£ä¸ºç»Ÿä¸€é…ç½®æ¨¡å‹ï¼Œè¯´æ³•è™½ç„¶ä¸åŒï¼Œä½†éƒ½åœ¨è¡¨è¾¾ä¸€ä¸ªæ„æ€ï¼Œè¿™æ ·çš„URLåœ¨dubboä¸­è¢«å½“åšæ˜¯å…¬å…±å¥‘çº¦ï¼ŒURLä½œä¸ºä¸Šä¸‹æ–‡ä¿¡æ¯è´¯ç©¿æ•´ä¸ªæ¡†æ¶ã€‚

### Invoker

Invokeræ˜¯Dubboçš„æ ¸å¿ƒæ¨¡å‹ï¼Œä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œä½“ã€‚åœ¨æœåŠ¡æä¾›æ–¹ï¼ŒInvokerç”¨äºè°ƒç”¨æœåŠ¡æä¾›ç±»ã€‚åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ï¼ŒInvokerç”¨äºæ‰§è¡Œè¿œç¨‹è°ƒç”¨ã€‚

### Invocation

è°ƒç”¨å¯¹è±¡

### Java SPI

ä¸Šé¢æœ‰è§£é‡Š

### Dubbo API

ä¸Šé¢ä¹Ÿæœ‰è¯¦ç»†è¯´æ˜

### `@SPI`

ä¿®é¥°åœ¨æ¥å£ä¸Šï¼Œæ³¨è§£çš„å€¼ä»£è¡¨çš„è¯¥æ¥å£é»˜è®¤çš„æ‰©å±•ç‚¹åã€‚

### `@Adaptive`

å¯ä»¥ä¿®é¥°åœ¨ç±»å’Œæ¥å£çš„æ–¹æ³•ä¸Šã€‚

1. å½“ä¿®é¥°åœ¨ç±»ä¸Šæ—¶ï¼Œè¡¨ç¤ºè¯¥ç±»ä¸ºæ‰€å®ç°çš„æ¥å£çš„ä»£ç†ç±»å®ç°
2. å½“ä¿®é¥°åœ¨æ¥å£æ–¹æ³•ä¸Šï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰äººå·¥çš„ä»£ç†ç±»å®ç°ï¼Œéœ€è¦ä¾èµ–Dubboè‡ªåŠ¨ç”Ÿæˆä»£ç†ç±»ï¼Œè€Œè¿™ä¸ªä»£ç†ç±»æ‰€å¯¹åº”çš„å®ä¾‹åœ¨è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•è¢«`@Adaptive`ä¿®é¥°äº†ï¼Œåˆ™ä¼šä»URLä¸­å–å€¼ä½œä¸ºæ‰©å±•ç‚¹åå»åŠ è½½å®ç°ç±»å¹¶å®ä¾‹åŒ–ï¼Œæœ€åå†ä½¿ç”¨è¿™ä¸ªå®ä¾‹è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œ`@Adaptive`çš„å€¼ä¸€èˆ¬å°±æ˜¯åœ¨è¿™ä¸ªåœºæ™¯ä¸­æ‰æœ‰ç”¨ï¼Œç”¨æ¥æŒ‡å®šå¯ä»¥ä»URLä¸­çš„å“ªä¸ªkeyå¯ä»¥è·å–åˆ°å€¼ã€‚

## æ€»ç»“

å…¶å®Dubboçš„å¯æ‰©å±•æœºåˆ¶å°±æ˜¯åŸºäºJava SPIçš„å¦ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡è¯»å–key/valueå½¢å¼çš„é…ç½®ç±»ï¼Œå°†å®ç°ç±»å®ä¾‹åŒ–å³å¯ï¼Œä½†æ˜¯dubboçš„è‡ªåŠ¨æ³¨å…¥å³å®ç°ç±»ä¸­åŠ äº†setæ–¹æ³•æ˜¯é€šè¿‡ç”Ÿæˆè¢«æ‰©å±•æ¥å£çš„ä»£ç†ç±»ï¼Œç„¶åå°†ä»£ç†ç±»setè¿›å®ƒçš„å®ç°ç±»é‡Œé¢å®Œæˆäº†è‡ªåŠ¨æ³¨å…¥ï¼ˆå› ä¸ºdubboåˆ›å»ºçš„ä»£ç†ç±»ä¼šå°†æ‰©å±•æ¥å£ä¸­åŠ äº†@Adaptiveæ–¹æ³•å¯¹åº”çš„å®ç°ç±»ä»URLä¸­æ‰¾åˆ°ï¼‰ï¼Œä¹Ÿå°±æ˜¯å¯¹Dubboè¿›è¡Œäº†æœåŠ¡æ‰©å±•ï¼Œè¿™å°±æ˜¯Dubboçš„å¯æ‰©å±•æœºåˆ¶ã€‚