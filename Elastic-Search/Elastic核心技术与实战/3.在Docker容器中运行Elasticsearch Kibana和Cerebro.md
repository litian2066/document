# 在Docker容器中运行Elasticsearch Kibana和Cerebro

1. 安装Docker 与 Docker Compose

   访问https://docs.docker.com/desktop/mac/install/

   ![image-20220508161431333](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220508161431333.png)

2. 按照官网提示安装docker（选择自己对应的芯片，我这儿是mac，所以傻瓜式安装）

3. 添加加速地址，以下是我的加速地址

   ![image-20220508182521260](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220508182521260.png)
   
   ```json
   {
     "builder": {
       "gc": {
         "defaultKeepStorage": "20GB",
         "enabled": true
       }
     },
     "experimental": false,
     "features": {
       "buildkit": true
     },
     "registry-mirrors": [
         "https://gpdm9i3j.mirror.aliyuncs.com"
     ]
}
   ```

4. 安装docker-compose

   mac安装的docker默认携带docker-compose，使用以下命令可以查看是否安装？

   **➜** **~** docker-compose --version

   ```shell
   docker-compose version 1.29.2, build 5becea4c
   ```

5. 编辑docker-compose.yaml文件

   ```yaml
   version: '2.2'
   services:
     cerebro:
       image: lmenezes/cerebro:0.8.3
       container_name: cerebro
       ports:
         - "9000:9000"
       command:
         - -Dhosts.0.host=http://elasticsearch:9200
       networks:
         - es7net
     kibana:
       image: docker.elastic.co/kibana/kibana:7.1.0
       container_name: kibana7
       environment:
         - I18N_LOCALE=zh-CN
         - XPACK_GRAPH_ENABLED=true
         - TIMELION_ENABLED=true
         - XPACK_MONITORING_COLLECTION_ENABLED="true"
         - ELASTICSEARCH_USERNAME=kibana
         - ELASTICSEARCH_PASSWORD=demo_password
       ports:
         - "5601:5601"
       networks:
         - es7net
     elasticsearch:
       image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0
       container_name: es7_01
       environment:
         - cluster.name=test-es
         - node.name=es7_01
         - bootstrap.memory_lock=true
         - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
         - "TZ=Asia/Shanghai"
         - discovery.type=single-node
         - path.data=node0_data
         - xpack.security.enabled=true
         - xpack.security.transport.ssl.enabled=false
       ulimits:
         memlock:
           soft: -1
           hard: -1
       privileged: true
       volumes:
         - /data/es7data1:/usr/share/elasticsearch/data
       ports:
         - 9200:9200
       networks:
         - es7net
   
   networks:
     es7net:
       driver: bridge
   ```

6. 执行命令启动

   在docker-compose.yml 文件所在的目录执行下面命令，后台启动容器。

   ````shell
   docker-compose up --build -d
   ````

7. 错误分析

   ![image-20220508191151486](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220508191151486.png)

   命令行启动的时候遇上以上问题，于是我使用mac的docker客户端进行启动，这会儿错误就比较明显

   ![image-20220508191513135](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220508191513135.png)

   由于这是我在网上找的配置文件，启动的时候需要在docker里面的resource的share文件配置相应的信息

   ![image-20220509090011136](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220509090011136.png)

   但是以上文件是单机模式，需要进入到容器内部设置密码才能访问，于是这儿采用非密码集群的方式启动

8. 正确的Elastic相关的docker-compose文件

   ````yaml
   version: '2.2'
   services:
     cerebro:
       image: lmenezes/cerebro:0.8.3
       container_name: cerebro
       ports:
         - "9000:9000"
       command:
         - -Dhosts.0.host=http://elasticsearch:9200
       networks:
         - es7net
     kibana:
       image: docker.elastic.co/kibana/kibana:7.1.0
       container_name: kibana7
       environment:
         - I18N_LOCALE=zh-CN
         - XPACK_GRAPH_ENABLED=true
         - TIMELION_ENABLED=true
         - XPACK_MONITORING_COLLECTION_ENABLED="true"
       ports:
         - "5601:5601"
       networks:
         - es7net
     elasticsearch:
       image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0
       container_name: es7_01
       environment:
         - cluster.name=geektime
         - node.name=es7_01
         - bootstrap.memory_lock=true
         - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
         - discovery.seed_hosts=es7_01,es7_02
         - cluster.initial_master_nodes=es7_01,es7_02
       ulimits:
         memlock:
           soft: -1
           hard: -1
       volumes:
         - es7data1:/usr/share/elasticsearch/data
       ports:
         - 9200:9200
       networks:
         - es7net
     elasticsearch2:
       image: docker.elastic.co/elasticsearch/elasticsearch:7.1.0
       container_name: es7_02
       environment:
         - cluster.name=geektime
         - node.name=es7_02
         - bootstrap.memory_lock=true
         - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
         - discovery.seed_hosts=es7_01,es7_02
         - cluster.initial_master_nodes=es7_01,es7_02
       ulimits:
         memlock:
           soft: -1
           hard: -1
       volumes:
         - es7data2:/usr/share/elasticsearch/data
       networks:
         - es7net
   
   
   volumes:
     es7data1:
       driver: local
     es7data2:
       driver: local
   
   networks:
     es7net:
       driver: bridge
   ````

9. 访问*cerebro*[http://localhost:9000/#/connect]

   ![image-20220509143650440](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220509143650440.png)

10. 选择已经知道的ES集群，自动连接，下图包含了ES的集群信息以及节点和索引大小之类的信息，关于详细使用，在之后的地方会提及（集群的名字不同是因为我后来用了下7.8.1的版本来测试，为了防止docker container名称相同导致的启动失败，所以改了个名字）

    ![image-20220509143743707](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220509143743707.png)