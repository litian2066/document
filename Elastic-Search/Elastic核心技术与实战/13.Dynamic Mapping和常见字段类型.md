# Dynamic Mapping和常见字段类型

## 什么是Mapping

+ Mapping类似数据库中的schema定义，作用如下：

  + 定义索引中的字段的名称
  + 定义字段的数据类型，例如字符串，数字，布尔.....
  + 字段，倒排索引的相关配置，（Analyzed or Not Analyzed， Analyzer）可以让字段不被索引

+ Mapping会把JSON文档映射成Lucene所需要的扁平格式

+ 一个Mapping属于一个Type

  + 每个文档都属于一个Type
  + 一个Type有一个Mapping定义
  + 7.0开始，不需要在Mapping定义中指定type信息

## 字段的数据类型

+ 简单类型
  + Text / Keyword
  + Date
  + Integer / Floating
  + Boolean
  + IPv4 & IPv6
+ 复杂类型 - 对象和嵌套对象
  + 对象类型/ 嵌套类型
+ 特殊类型
  + geo_point & geo_shape / percolator

## 什么是Dynamic Mapping

+ 在写入文档时候，如果索引不存在，会自动创建索引
+ Dynamic Mapping的机制，使得我们无需手动定义Mappings。Elasticsearch会自动根据文档信息，推算出字段的类型
+ 但是有时候会推算的不对，例如地理位置信息
+ 当类型如果设置不对时，会导致一些功能无法正常运行，例如Range查询

![image-20220510151110314](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510151110314.png)

## 类型的自动识别

| JSON类型 | Elasticsearch类型                                            |
| -------- | ------------------------------------------------------------ |
| 字符串   | 匹配日期格式，设置成Date<br>配置数字设置为float或者long，该选项默认关闭<br>设置成Text，并且增加keyword子字段 |
| 布尔值   | boolean                                                      |
| 浮点数   | float                                                        |
| 整数     | long                                                         |
| 对象     | Object                                                       |
| 数组     | 由第一个非空数值的类型所决定                                 |
| 空值     | 忽略                                                         |

一个小例子

````shell
PUT mapping_test/_doc/1
{
  "firstName": "Chan",
  "lastName": "Jackie",
  "loginDate": "2018-07-24T10:29:48.103Z"
}
````

````shell
GET mapping_test/_mapping
````

````json
{
  "mapping_test" : {
    "mappings" : {
      "properties" : {
        "firstName" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "lastName" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "loginDate" : {
          "type" : "date"
        }
      }
    }
  }
}
````

在看另一个例子

```
DELETE mapping_test
```

````shell
PUT mapping_test/_doc/1
{
  "uid": "123",
  "isVip": false,
  "isAdmin": "true",
  "age": 19,
  "height": 180
}
````

````
GET mapping_test/_mapping
````

````json
{
  "mapping_test" : {
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "long"
        },
        "height" : {
          "type" : "long"
        },
        "isAdmin" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "isVip" : {
          "type" : "boolean"
        },
        "uid" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    }
  }
}
````

## 能否更改Mapping的字段类型

+ 两种情况
  + 新增字段
    + Dynamic 设为true时，一旦有新增字段的文档写入，Mapping也同时被更新
    + Dynamic 设为false，Mapping不会被更新，新增字段的数据无法被索引，但是信息会出现在_source中
    + Dynamic设置成Strict，文档写入失败
  + 对已有字段，一旦已经有数据写入，就不再支持修改字段定义
    + Lucene实现的倒排索引，一旦生成后，就不允许修改
  + 如果希望改变字段类型，必须Reindex API，重建索引
+ 原因
  + 如果修改了字段的数据类型，会导致已被索引的属于无法被搜索
  + 但是如果是增加新的字段，就不会有这样的影响

## 控制Dynamic Mappings

+ 当dynamic被设置成false的时候，存在新增字段的数据写入，该数据可以被索引，但是新增字段废弃
+ 当设置成strict模式的时候，数据写入直接报错

![image-20220510152451088](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510152451088.png)

````shell
PUT dynamic_mapping_test/_doc/1
{
  "newField": "someValue"
}
````

````shell
POST dynamic_mapping_test/_search
{
  "query": {
    "match": {
      "newField": "someValue"
    }
  }
}
````

```shell
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 0.2876821,
    "hits" : [
      {
        "_index" : "dynamic_mapping_test",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 0.2876821,
        "_source" : {
          "newField" : "someValue"
        }
      }
    ]
  }
}
```

修改dynamic false

````shell
PUT dynamic_mapping_test/_mapping
{
  "dynamic": false
}
````

````json
#新增字段
PUT dynamic_mapping_test/_doc/10
{
  "anotherField": "someValue"
}
# 该字段不能被搜索，因为dynamic设置为了false了
POST dynamic_mapping_test/_search
{
  "query": {
    "match": {
      "anotherField": "someValue"
    }
  }
}
````

````
{
  "took" : 296,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 0,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  }
}
````

