# Elasticsearch聚合分析简介

## 什么是聚合（Aggregation）

> 在很多搜索网站都提供了过滤的栏位

![image-20220510170914268](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510170914268.png)

> Hadoop得到统计结果可能需要一天时间

![image-20220510171001037](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171001037.png)

## Kibana 可视化报表 - 聚合分析

![image-20220510171108978](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171108978.png)

## 集合的分类

![image-20220510171247611](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171247611.png)

## Bucket & Metric

![image-20220510171346237](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171346237.png)

## Bucket

![image-20220510171423636](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171423636.png)

## Metric

![image-20220510171603402](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171603402.png)

## 一个Bucket例子

![image-20220510171647473](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171647473.png)

## 加入Metric

![image-20220510171758951](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510171758951.png)

## 嵌套

![image-20220510172158531](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510172158531.png)

## 	一些例子

### 按照目的地进行分桶统计

````shell
# 按照目的地进行分桶统计
GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "flight_dest": {
      "terms": {
        "field": "DestCountry"
      }
    }
  }
}
````

````json
{
  "took" : 16,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "flight_dest" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 3187,
      "buckets" : [
        {
          "key" : "IT",
          "doc_count" : 2371
        },
        {
          "key" : "US",
          "doc_count" : 1987
        },
        {
          "key" : "CN",
          "doc_count" : 1096
        },
        {
          "key" : "CA",
          "doc_count" : 944
        },
        {
          "key" : "JP",
          "doc_count" : 774
        },
        {
          "key" : "RU",
          "doc_count" : 739
        },
        {
          "key" : "CH",
          "doc_count" : 691
        },
        {
          "key" : "GB",
          "doc_count" : 449
        },
        {
          "key" : "AU",
          "doc_count" : 416
        },
        {
          "key" : "PL",
          "doc_count" : 405
        }
      ]
    }
  }
}
````

### 查看航班目的地的统计信息，增加平均、最高最低价格   

````shell
# 查看航班目的地的统计信息，增加平均、最高最低价格     
GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "flight_dest": {
      "terms": {
        "field": "DestCountry"
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        },
        "max_price": {
          "max": {
            "field": "AvgTicketPrice"
          }
        },
        "min_price": {
          "min": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}
````

````json
{
  "took" : 73,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "flight_dest" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 3187,
      "buckets" : [
        {
          "key" : "IT",
          "doc_count" : 2371,
          "max_price" : {
            "value" : 1195.3363037109375
          },
          "min_price" : {
            "value" : 100.57646942138672
          },
          "avg_price" : {
            "value" : 586.9627099618385
          }
        },
        {
          "key" : "US",
          "doc_count" : 1987,
          "max_price" : {
            "value" : 1199.72900390625
          },
          "min_price" : {
            "value" : 100.14596557617188
          },
          "avg_price" : {
            "value" : 595.7743908825026
          }
        },
        {
          "key" : "CN",
          "doc_count" : 1096,
          "max_price" : {
            "value" : 1198.4901123046875
          },
          "min_price" : {
            "value" : 102.90382385253906
          },
          "avg_price" : {
            "value" : 640.7101617033464
          }
        },
        {
          "key" : "CA",
          "doc_count" : 944,
          "max_price" : {
            "value" : 1198.8525390625
          },
          "min_price" : {
            "value" : 100.5572509765625
          },
          "avg_price" : {
            "value" : 648.7471090413757
          }
        },
        {
          "key" : "JP",
          "doc_count" : 774,
          "max_price" : {
            "value" : 1199.4913330078125
          },
          "min_price" : {
            "value" : 103.97209930419922
          },
          "avg_price" : {
            "value" : 650.9203447346847
          }
        },
        {
          "key" : "RU",
          "doc_count" : 739,
          "max_price" : {
            "value" : 1196.7423095703125
          },
          "min_price" : {
            "value" : 101.0040054321289
          },
          "avg_price" : {
            "value" : 662.9949632162009
          }
        },
        {
          "key" : "CH",
          "doc_count" : 691,
          "max_price" : {
            "value" : 1196.496826171875
          },
          "min_price" : {
            "value" : 101.3473129272461
          },
          "avg_price" : {
            "value" : 575.1067587028537
          }
        },
        {
          "key" : "GB",
          "doc_count" : 449,
          "max_price" : {
            "value" : 1197.78564453125
          },
          "min_price" : {
            "value" : 111.34574890136719
          },
          "avg_price" : {
            "value" : 650.5326856005696
          }
        },
        {
          "key" : "AU",
          "doc_count" : 416,
          "max_price" : {
            "value" : 1197.6326904296875
          },
          "min_price" : {
            "value" : 102.2943115234375
          },
          "avg_price" : {
            "value" : 669.5588319668403
          }
        },
        {
          "key" : "PL",
          "doc_count" : 405,
          "max_price" : {
            "value" : 1185.43701171875
          },
          "min_price" : {
            "value" : 104.28328704833984
          },
          "avg_price" : {
            "value" : 662.4497233072917
          }
        }
      ]
    }
  }
}
````

## 价格统计信息+天气统计信息

````shell
GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "flight_dest": {
      "terms": {
        "field": "DestCountry"
      },
      "aggs": {
        "status_price": {
          "stats": {
            "field": "AvgTicketPrice"
          }
        },
        "weather": {
          "terms": {
            "field": "DestWeather",
            "size": 5
          }
        }
      }
    }
  }
}
````

````json
{
  "took" : 89,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "flight_dest" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 3187,
      "buckets" : [
        {
          "key" : "IT",
          "doc_count" : 2371,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 506,
            "buckets" : [
              {
                "key" : "Clear",
                "doc_count" : 428
              },
              {
                "key" : "Sunny",
                "doc_count" : 424
              },
              {
                "key" : "Rain",
                "doc_count" : 417
              },
              {
                "key" : "Cloudy",
                "doc_count" : 414
              },
              {
                "key" : "Heavy Fog",
                "doc_count" : 182
              }
            ]
          },
          "status_price" : {
            "count" : 2371,
            "min" : 100.57646942138672,
            "max" : 1195.3363037109375,
            "avg" : 586.9627099618385,
            "sum" : 1391688.585319519
          }
        },
        {
          "key" : "US",
          "doc_count" : 1987,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 438,
            "buckets" : [
              {
                "key" : "Rain",
                "doc_count" : 371
              },
              {
                "key" : "Clear",
                "doc_count" : 346
              },
              {
                "key" : "Sunny",
                "doc_count" : 345
              },
              {
                "key" : "Cloudy",
                "doc_count" : 330
              },
              {
                "key" : "Heavy Fog",
                "doc_count" : 157
              }
            ]
          },
          "status_price" : {
            "count" : 1987,
            "min" : 100.14596557617188,
            "max" : 1199.72900390625,
            "avg" : 595.7743908825026,
            "sum" : 1183803.7146835327
          }
        },
        {
          "key" : "CN",
          "doc_count" : 1096,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 229,
            "buckets" : [
              {
                "key" : "Sunny",
                "doc_count" : 209
              },
              {
                "key" : "Rain",
                "doc_count" : 207
              },
              {
                "key" : "Clear",
                "doc_count" : 192
              },
              {
                "key" : "Cloudy",
                "doc_count" : 173
              },
              {
                "key" : "Thunder & Lightning",
                "doc_count" : 86
              }
            ]
          },
          "status_price" : {
            "count" : 1096,
            "min" : 102.90382385253906,
            "max" : 1198.4901123046875,
            "avg" : 640.7101617033464,
            "sum" : 702218.3372268677
          }
        },
        {
          "key" : "CA",
          "doc_count" : 944,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 189,
            "buckets" : [
              {
                "key" : "Clear",
                "doc_count" : 198
              },
              {
                "key" : "Rain",
                "doc_count" : 173
              },
              {
                "key" : "Cloudy",
                "doc_count" : 156
              },
              {
                "key" : "Sunny",
                "doc_count" : 148
              },
              {
                "key" : "Damaging Wind",
                "doc_count" : 80
              }
            ]
          },
          "status_price" : {
            "count" : 944,
            "min" : 100.5572509765625,
            "max" : 1198.8525390625,
            "avg" : 648.7471090413757,
            "sum" : 612417.2709350586
          }
        },
        {
          "key" : "JP",
          "doc_count" : 774,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 165,
            "buckets" : [
              {
                "key" : "Rain",
                "doc_count" : 152
              },
              {
                "key" : "Sunny",
                "doc_count" : 138
              },
              {
                "key" : "Clear",
                "doc_count" : 130
              },
              {
                "key" : "Cloudy",
                "doc_count" : 123
              },
              {
                "key" : "Damaging Wind",
                "doc_count" : 66
              }
            ]
          },
          "status_price" : {
            "count" : 774,
            "min" : 103.97209930419922,
            "max" : 1199.4913330078125,
            "avg" : 650.9203447346847,
            "sum" : 503812.346824646
          }
        },
        {
          "key" : "RU",
          "doc_count" : 739,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 161,
            "buckets" : [
              {
                "key" : "Cloudy",
                "doc_count" : 149
              },
              {
                "key" : "Rain",
                "doc_count" : 128
              },
              {
                "key" : "Clear",
                "doc_count" : 122
              },
              {
                "key" : "Sunny",
                "doc_count" : 117
              },
              {
                "key" : "Thunder & Lightning",
                "doc_count" : 62
              }
            ]
          },
          "status_price" : {
            "count" : 739,
            "min" : 101.0040054321289,
            "max" : 1196.7423095703125,
            "avg" : 662.9949632162009,
            "sum" : 489953.27781677246
          }
        },
        {
          "key" : "CH",
          "doc_count" : 691,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 128,
            "buckets" : [
              {
                "key" : "Cloudy",
                "doc_count" : 135
              },
              {
                "key" : "Sunny",
                "doc_count" : 134
              },
              {
                "key" : "Clear",
                "doc_count" : 128
              },
              {
                "key" : "Rain",
                "doc_count" : 115
              },
              {
                "key" : "Heavy Fog",
                "doc_count" : 51
              }
            ]
          },
          "status_price" : {
            "count" : 691,
            "min" : 101.3473129272461,
            "max" : 1196.496826171875,
            "avg" : 575.1067587028537,
            "sum" : 397398.7702636719
          }
        },
        {
          "key" : "GB",
          "doc_count" : 449,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 93,
            "buckets" : [
              {
                "key" : "Rain",
                "doc_count" : 93
              },
              {
                "key" : "Sunny",
                "doc_count" : 81
              },
              {
                "key" : "Clear",
                "doc_count" : 77
              },
              {
                "key" : "Cloudy",
                "doc_count" : 71
              },
              {
                "key" : "Heavy Fog",
                "doc_count" : 34
              }
            ]
          },
          "status_price" : {
            "count" : 449,
            "min" : 111.34574890136719,
            "max" : 1197.78564453125,
            "avg" : 650.5326856005696,
            "sum" : 292089.17583465576
          }
        },
        {
          "key" : "AU",
          "doc_count" : 416,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 93,
            "buckets" : [
              {
                "key" : "Rain",
                "doc_count" : 80
              },
              {
                "key" : "Cloudy",
                "doc_count" : 75
              },
              {
                "key" : "Clear",
                "doc_count" : 73
              },
              {
                "key" : "Sunny",
                "doc_count" : 57
              },
              {
                "key" : "Hail",
                "doc_count" : 38
              }
            ]
          },
          "status_price" : {
            "count" : 416,
            "min" : 102.2943115234375,
            "max" : 1197.6326904296875,
            "avg" : 669.5588319668403,
            "sum" : 278536.47409820557
          }
        },
        {
          "key" : "PL",
          "doc_count" : 405,
          "weather" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 90,
            "buckets" : [
              {
                "key" : "Clear",
                "doc_count" : 74
              },
              {
                "key" : "Rain",
                "doc_count" : 71
              },
              {
                "key" : "Cloudy",
                "doc_count" : 67
              },
              {
                "key" : "Sunny",
                "doc_count" : 66
              },
              {
                "key" : "Thunder & Lightning",
                "doc_count" : 37
              }
            ]
          },
          "status_price" : {
            "count" : 405,
            "min" : 104.28328704833984,
            "max" : 1185.43701171875,
            "avg" : 662.4497233072917,
            "sum" : 268292.1379394531
          }
        }
      ]
    }
  }
}
````



