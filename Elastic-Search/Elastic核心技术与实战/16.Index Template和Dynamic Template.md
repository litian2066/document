# Index Template和Dynamic Template

## 什么是Index Template

+ Index Template - 帮助你设定Mappings 和 Settings，并按照一定的规则，自动匹配到新创建的索引之上
  + 模板仅在一个索引被新创建时，才会产生作用。修改模板不会影响已经创建的索引
  + 你可以设定多个索引模板，这些设置会被“merge”在一起
  + 你可以指定“order”的数值，控制“mergeing”的过程

## 两个Index Templates

![image-20220510165731166](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510165731166.png)

+ 左边的规则是：在创建索引的时候设置主分片和副本分片的个数都是1
+ 右边的规则是：当创建**test**开头的索引的时候设置主分片为1，副本分片的个数是2，同时还设置了**当字符串是日期格式的时候不转换日期数据，同时如果字符串是数字的话转换成数字**

## Index Templates的工作方式

+ 当一个索引被新创建时
  + 应用Elasticsearch 默认的settings 和mappings
  + 应用order数值低的Index Templates中的设定
  + 应用order高的Index Templates中的设定，之前的设定会被覆盖
  + 应用创建索引时，用户所指定的Settings 和 Mappings，并覆盖之前模板中的设定

## Demo

+ 创建2个 Index Templates
+ 查看 根据名字查看 Template
+ 查看所有templates，`_template/*`
+ 创建一个临时索引，查看replica和数据类型推断
+ 将索引名字设为能Index Templates匹配时，查看所生成的Index 的 mappings 和 Settings

````json
# 回顾下dynamic mapping 
PUT ttemplate/_doc/1
{
  "someNumber": "1",
  "someDate": "2019/01/01"
}
# 查看默认插入文档的索引的mapping
GET ttemplate/_mapping
````

````json
{
  "ttemplate" : {
    "mappings" : {
      "properties" : {
        "someDate" : {
          "type" : "date",
          "format" : "yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis"
        },
        "someNumber" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    }
  }
}
````

````json
# 设置1个index template 匹配所有的索引
PUT _template/template_default
{
  "index_patterns": ["*"],
  "order": 0,
  "version": 1,
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  }
}
# 设置1个index template 匹配test开头的索引
PUT _template/template_test
{
  "index_patterns": ["test*"],
  "order": 1,
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 2
  },
  "mappings": {
    "date_detection": false,
    "numeric_detection": true
  }
}
````

```json
# 查看template信息
GET /_template/template_default
```

```json
{
  "template_default" : {
    "order" : 0,
    "version" : 1,
    "index_patterns" : [
      "*"
    ],
    "settings" : {
      "index" : {
        "number_of_shards" : "1",
        "number_of_replicas" : "1"
      }
    },
    "mappings" : { },
    "aliases" : { }
  }
}
```

````json
GET /_template/temp*
````

````json
{
  "template_test" : {
    "order" : 1,
    "index_patterns" : [
      "test*"
    ],
    "settings" : {
      "index" : {
        "number_of_shards" : "1",
        "number_of_replicas" : "2"
      }
    },
    "mappings" : {
      "numeric_detection" : true,
      "date_detection" : false
    },
    "aliases" : { }
  },
  "template_default" : {
    "order" : 0,
    "version" : 1,
    "index_patterns" : [
      "*"
    ],
    "settings" : {
      "index" : {
        "number_of_shards" : "1",
        "number_of_replicas" : "1"
      }
    },
    "mappings" : { },
    "aliases" : { }
  }
}
````

````json
# 写入新的数据，index以test开头
PUT testtemplate/_doc/1
{
  "someNumber": "1",
  "someDate": "2019/01/01"
}
GET testtemplate/_mapping
````

````json
{
  "testtemplate" : {
    "mappings" : {
      "date_detection" : false,
      "numeric_detection" : true,
      "properties" : {
        "someDate" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "someNumber" : {
          "type" : "long"
        }
      }
    }
  }
}
````

````json
GET testtemplate/_settings
````

````json
{
  "testtemplate" : {
    "settings" : {
      "index" : {
        "creation_date" : "1622907501151",
        "number_of_shards" : "1",
        "number_of_replicas" : "2",
        "uuid" : "ApRBKKjTTcWjmwq9Uj4blA",
        "version" : {
          "created" : "7080199"
        },
        "provided_name" : "testtemplate"
      }
    }
  }
}
````

````json
# 自己设置setting 或覆盖所有
PUT testmy
{
  "settings": {
    "number_of_replicas": 5
  }
}

PUT testmy/_doc/1
{
  "key": "value"
}
GET testmy/_settings
````

```json
{
  "testmy" : {
    "settings" : {
      "index" : {
        "creation_date" : "1622907661585",
        "number_of_shards" : "1",
        "number_of_replicas" : "5",
        "uuid" : "ScJ_fR2yR5GEKqo7SwJUIg",
        "version" : {
          "created" : "7080199"
        },
        "provided_name" : "testmy"
      }
    }
  }
}
```

删除索引和template

````json
DELETE testmy

DELETE /_template/template_default
DELETE /_template/template_test
````



## 什么是Dynamic Template

+ 根据Elasticsearch 识别的数据类型，结合字段名称，来动态设定字段类型
  + 比如所有的字符串类型设定成Keyword，或者关闭keyword字段
  + is开头的字段都设置成boolean
  + long_开头的都设置成long类型

## Dynamic Template

+ Dynamic Template 是定义在某个索引的Mapping中的
+ Template有一个名称
+ 匹配规则是一个数组
+ 为匹配到的字段设置Mapping

![image-20220510170442949](/Users/litian/Documents/lian2077/documents/documents/Elastic-Search/Elastic核心技术与实战/images/image-20220510170442949.png)

## DEMO

```json
# 设置一个dynamic mapping
PUT my_index 
{
  "mappings": {
    "dynamic_templates": [
      {
        "strings_as_boolean": {
          "match_mapping_type": "string",
          "match": "is*",
          "mapping": {
            "type": "boolean"
          }
        }
      },
      {
        "strings_as_keywords": {
          "match_mapping_type": "string",
          "mapping": {
            "type": "keyword"
          }
        }
      }
    ]
  }
}
```

````json
PUT my_index/_doc/1
{
  "firstName":"Ruan",
  "isVip": "true"
}

GET my_index/_mapping
````

```json
{
  "my_index" : {
    "mappings" : {
      "dynamic_templates" : [
        {
          "strings_as_boolean" : {
            "match" : "is*",
            "match_mapping_type" : "string",
            "mapping" : {
              "type" : "boolean"
            }
          }
        },
        {
          "strings_as_keywords" : {
            "match_mapping_type" : "string",
            "mapping" : {
              "type" : "keyword"
            }
          }
        }
      ],
      "properties" : {
        "firstName" : {
          "type" : "keyword"
        },
        "isVip" : {
          "type" : "boolean"
        }
      }
    }
  }
}

```

```json
PUT my_index 
{
  "mappings": {
    "dynamic_templates": [
      {
        "full_name": {
          "path_match": "name.*",
          "path_unmatch": "*.middle",
          "mapping": {
            "type": "text",
            "copy_to": "full_name"
          }
        }
      }
    ]
  }
}

PUT my_index/_doc/1
{
  "name": {
    "first": "John",
    "middle": "Winston",
    "last": "Lennon"
  }
}

GET my_index/_search?q=full_name:John
```

```json
{
  "took" : 628,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 0.2876821,
    "hits" : [
      {
        "_index" : "my_index",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 0.2876821,
        "_source" : {
          "name" : {
            "first" : "John",
            "middle" : "Winston",
            "last" : "Lennon"
          }
        }
      }
    ]
  }
}
```

