# 分页组件用户手册

## 1.组件介绍

  分页组件是基于Spring Boot Starter实现的组件化功能，依赖于jdbc以及**Utils工具类**，由分页信息和分页参数两部分组成。此外此组件比较轻量，并且是物理分页组件，并不会给内存带来大的消耗。

+ 分页信息主要是负责将查询好的数据包装成统一的数据类返回给前台，其中包含分页的信息以及查询的数据实体，通过泛型将查询好的数据封装在里面。
+ 分页参数是前端传过来的分页信息参数化，即当前页以及每页显示条数包装一个参数类，传递给组件进行进一步的处理。

## 2.组件整体设计

### 2.1分页组件组成图

![image-20191230114449033](/Users/litian/Library/Application Support/typora-user-images/image-20191230114449033.png)

### 2.2组件工程结构图

![image-20191230151431467](/Users/litian/Library/Application Support/typora-user-images/image-20191230151431467.png)

## 3.组件功能说明

### 3.1JDBC组件

JDBC组件提供数据接口访问，主要提供五种API以支持分页数据查询，其中四种是方法重载，根据参数不同返回不同的分页数据。

#### 3.1.1分页API

| 返回值           | 方法签名                                                     | 说明                                                         |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `<E> Page<E>`    | `queryForPage(String var1, Object var2, Class<E> var3, PageParam var4);` | 查询分页，返回传入实体类的分页对象，sql语句参数是Object类型  |
| `<E, R> Page<R>` | `queryForPage(String var1, Object var2, Class<E> var3, PageParam var4, Function<E, R> var5);` | 查询分页，返回传入实体类的分页经由函数式接口转换后的分页对象，sql语句参数是Object类型 |
| `<E> Page<E>`    | `queryForPage(String var1, InputParameters var2, Class<E> var3, PageParam var4);` | 查询分页，返回传入实体类的分页对象，sql语句参数是封装的**key value**形式的对象 |
| `<E, R> Page<R>` | `queryForPage(String var1, InputParameters var2, Class<E> var3, PageParam var4, Function<E, R> var5);` | 查询分页，返回传入实体类的分页经由函数式接口转换后的分页对象，sql语句参数是**key value**形式的对象 |
| `Page`           | `queryForMapPage(String var1, Object var2, PageParam var3);` | 查询分页，返回分页对象，其中列表数据封装在**map**里面        |

#### 3.1.2分页参数PageParam

| 属性       | 类型 | 说明         |
| ---------- | ---- | ------------ |
| pageNumber | long | 当前行号     |
| pageSize   | long | 每页显示条数 |

### 3.2Utils工具类

#### 3.2.1Page工具类

| 属性        |         | 说明         |
| ----------- | ------- | ------------ |
| pageSize    | long    | 每页显示行数 |
| currentPage | long    | 当前页号     |
| items       | List<T> | 数据集       |
| totalRows   | long    | 总行数       |
| totalPage   | long    | 总页数       |

### 3.3前端组件EpPagenation

#### 3.3.1说明

![image-20191230135459044](/Users/litian/Library/Application Support/typora-user-images/image-20191230135459044.png)

前端采用了`EP-UI`的`EpPagenation`组件，提供选择每页显示条数、前一页、后一页、输入框指定页面跳转功能。区别于iview的分页组件，通过`onchange`事件返回的参数`curpage`, `pagesize`以及其他用户参数查询数据，查询完成后通过`callback(当前页数据条数，数据总条数，当前页码)`重新更新分页显示，对`ininpage`属性取反重新初始化分页。

````html
<template>
	<EpPagenation @onchange="pageevent"  :pageinit="pageinit" :isshowgopage="isshowgopage"></EpPagenation>
</template>
<script>
	export default {
    methods: {
      initpage() {
        // 重新初始化分页，会从第一页开始发起请求
        this.pageinit = !this.pageinit
      },
      pageevent(curpage, pagesize, $callback) {
        console.log(curpage, pagesize)
        // 通过curpage， pagesize以及其他参数querydata；
        // $callback(当前页数据条数，数据总条数，当前页码);当前页数据条数，数据总条数为必要参数
        // $callback(0, 0)
        // eslint-disable-next-line startdard/no-callback-literal
        $callback(10, 100)
      }
    }
  }
</script>
````

**在测试过程中如果参数直接命名为`callback`会没有反应，换成其他参数均能测试通过，所以上面换成了`$callback`。**

#### 3.3.1EpPagenation props

| 属性         | 说明                                   | 类型    | 默认值                                                       |
| ------------ | -------------------------------------- | ------- | ------------------------------------------------------------ |
| `pageinit`   | 初始化分页，每次初始化时候对值取反即可 | Boolean | True                                                         |
| `pageconfig` | 分页配置                               | Object  | {<br>`isshowtotal: true, // 是否显示总条数`<br>`isshowpagesize: true, // 是否显示当前页的数据条数`<br/>`isshowpagesizeselect: true, // 是否可以改变pageszie`<br/>`btncount: 7, // 最多显示的页码个数`<br/>`isshowfirstorlastpage: true, // 是否显示首页或尾页`<br/>`isshowgopage: true, //是否显示输入框`<br/>`pagesize: 10 // 默认每页数据条数`<br>} |

#### 3.3.2EpPagenation event

| 事件名     | 说明           | 返回值                                                       |
| ---------- | -------------- | ------------------------------------------------------------ |
| `onchange` | 分页改变是触发 | Curpage,pagesize,callback,其中callback为回调函数，数据请求完成后调用；callback(当前页数据条数，数据总条数，当前页码) |

#### 3.3.3EpPagenation slot

| 插槽名 | 说明 |
| ------ | ---- |
| -      | -    |

## 4.示例

### 4.1后端示例

#### 4.1.1实体类

示例采用实体类是公共组件项目里提供的示例实体类`Department`，对应的代码和`DTO`类如下：

##### 4.1.1.1Department

```java
/**
 * Created by SuperS on 2019/9/5.
 *
 * @author SuperS
 */
@Data
@Entity
@Table(name = "eco_department")
@EqualsAndHashCode(callSuper = true)
public class Department extends AbstractDomainValue implements CreateAndUpdateTimeable, UnDeletable {

    @Column(name = "department_name")
    private String name;

    /**
     * 创建时间
     */
    @Column(name = "create_time")
    private Date createTime;
    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private Date updateTime;
    /**
     * 删除标识
     */
    @Column(name = "deleted_flag")
    private Boolean deletedFlag;

    @Override
    public boolean isDeleted() {
        return deletedFlag;
    }

    @Override
    public void markedAsDeleted() {
        this.deletedFlag = Boolean.TRUE;
    }

    @Override
    public void markedAsAvailable() {
        this.deletedFlag = Boolean.FALSE;
    }

    public DepartmentDTO convert() {
       return DepartmentDTO.builder()
               .id(this.id)
               .name(this.name)
               .build();
    }
}
```

##### 4.1.1.2DepartmentDto

```java
/**
 * Created by SuperS on 2019/9/5.
 *
 * @author SuperS
 */
@Data
@ApiModel("部门实体")
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class DepartmentDTO {
    @ApiModelProperty("主键Id")
    private Long id;
    @ApiModelProperty("部门名称")
    private String name;
}
```

#### 4.1.2PaginationApi

API接口提供了两种分页查询示例，对应着`GET`和`POST`两种请求，查询接口使用`POST`考虑到前端查询可能有不止一种参数，可以把同一模块多个参数封装成一个dto对象用于传输。而`GET`请求用于单个或者几个不同模块参数的方式，因为前端封装的`axios`的`get`方法不支持这种对象参数传递的方式，需要将分页信息也一并封装到dto里面，需要看具体情况使用。

```java
/**
 * 分页示例
 * @author litian
 */
@Api(value = "Pagination Api", tags = {"分页示例"})
@FeignClient("${eco.sample.biz1.cloud-app-name}")
@RequestMapping(path = "/core-api/eco/sample/v1/pagination")
public interface PaginationApi {

    /**
     * 分页Post请求示例
     * @param departmentDTO
     * @param currentPage
     * @param pageSize
     * @return 分页<数据实体>
     */
    @ApiOperation(value = "分页Post请求示例", notes = "传递整个条件Dto以及分页信息，Post请求查询分页列表")
    @ApiImplicitParams({
            @ApiImplicitParam( name = "currentPage", value = "查询的页数", required = true, dataType = "Integer"),
            @ApiImplicitParam( name = "pageSize", value = "每页查询的数量", required = true, dataType = "Integer"),
            @ApiImplicitParam( name = "departmentDTO", value = "查询的条件dto", required = false, dataType = "DepartmentDTO")
    })
    @PostMapping("/findPaginationPage/{currentPage}/{pageSize}")
    JsonResponse<Page<DepartmentDTO>> findPaginationPage(@RequestBody DepartmentDTO departmentDTO,
                                                         @PathVariable Integer currentPage,
                                                         @PathVariable Integer pageSize);

    /**
     * 分页get请求示例
     * @param currentPage
     * @param name 传递参数
     * @param pageSize
     * @return 分页<数据实体>
     */
    @ApiOperation(value = "分页get请求示例", notes = "分页Post请求示例，Get请求查询分页列表")
    @ApiImplicitParams({
            @ApiImplicitParam( name = "currentPage", value = "查询的页数", required = true, dataType = "Integer"),
            @ApiImplicitParam( name = "pageSize", value = "每页查询的数量", required = true, dataType = "Integer"),
            @ApiImplicitParam( name = "name", value = "查询参数", required = false, dataType = "String")
    })
    @GetMapping("/findPaginationPage")
    JsonResponse<Page<DepartmentDTO>> findPaginationPage(@RequestParam(value = "name")String name,
                                                           @RequestParam(value = "currentPage") Integer currentPage,
                                                           @RequestParam(value = "pageSize") Integer pageSize);

}
```

#### 4.1.3PaginationController

```java
/**
 * 分页示例
 * @author litian
 */
@RestController
public class PaginationController implements PaginationApi {

    @Resource
    private PaginationService paginationService;

    @Override
    public JsonResponse<Page<DepartmentDTO>> findPaginationPage(DepartmentDTO departmentDTO, Integer currentPage, Integer pageSize) {
        return JsonResponse.ok(paginationService.findPaginationPage(departmentDTO, currentPage, pageSize));
    }

    @Override
    public JsonResponse<Page<DepartmentDTO>> findPaginationPage(String name, Integer currentPage, Integer pageSize) {
        return JsonResponse.ok(paginationService.findPaginationPage(name, currentPage, pageSize));
    }
}
```

#### 4.1.4PaginationService

```java
/**
 * 分页示例
 * @author litian
 */
public interface PaginationService {

    /**
     * 分页查询Post示例
     * @param departmentDTO 查询参数对象
     * @param pageNum
     * @param pageSize
     * @return
     */
    Page<DepartmentDTO> findPaginationPage(DepartmentDTO departmentDTO, Integer pageNum, Integer pageSize);

    /**
     * 分页查询Get示例
     * @param name 查询参数
     * @param currentPage
     * @param pageSize
     * @return
     */
    Page<DepartmentDTO> findPaginationPage(String name, Integer currentPage, Integer pageSize);

}
```

#### 4.1.5PaginationServiceImpl

```java
/**
 * 分页示例
 * @author litian
 */
@Service
@Slf4j
public class PaginationServiceImpl implements PaginationService {

    @Resource
    private JdbcQueryManager jdbcQueryManager;

    @Override
    public Page<DepartmentDTO> findPaginationPage(DepartmentDTO departmentDTO, Integer currentPage, Integer pageSize) {
        PageParam pageParam = PageParam.create(currentPage, pageSize);
        return jdbcQueryManager.queryForPage("departmentService_findByPage",
                InputParameters.create("departmentName", departmentDTO == null ?  null : departmentDTO.getName()),
                Department.class,
                pageParam,
                Department::convert);
    }

    @Override
    public Page<DepartmentDTO> findPaginationPage(String name, Integer currentPage, Integer pageSize) {
        PageParam pageParam = PageParam.create(currentPage, pageSize);
        return jdbcQueryManager.queryForPage("departmentService_findByPage",
                InputParameters.create("departmentName", name),
                Department.class,
                pageParam,
                Department::convert);
    }

}
```

#### 4.1.6eco-department-sql.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<dal:dalScripts domainCode="eco_sample" xmlns:dal="urn:com.gsww.cd.commons.dal:commons-dal:scripts">
    <dal:select id="departmentService_findByName">
        select
        id, department_name, deleted_flag, create_time, update_time
        from eco_department department
        where department_name = #{departmentName}
        and deleted_flag = 0
    </dal:select>

    <dal:select id="departmentService_findByPage">
        select
        id, department_name, deleted_flag, create_time, update_time
        from eco_department department
        where deleted_flag = 0
        <dal:if test="departmentName != null and departmentName != ''">
            and department.department_name = #{departmentName}
        </dal:if>
    </dal:select>
</dal:dalScripts>
```

### 4.2前端示例

````html
<template>
	<EpPagenation @onchange="pageevent"   :pageinit="pageinit" :pageconfig="pageconfig"></EpPagenation>
</template>
import { post, get } from './../../../../api/http'
export default {
  name: 'list',
  data() {
    return {
      page: {
        pageNum: 1,
        pageSize: 1,
        totalRows: 0
      },
      params: {
        name: ''
      },
      pageconfig: {
        pagesize: 4
      }
    }
  },
  methods: {
    pageevent(curpage, pagesize, $callback) {
      if (curpage === 0) {
        return
      }
      // 通过curpage, pagesize以及其他参数querydata;
      // callback(当前页数据条数, 数据总条数,当前页码); 当前页数据条数, 数据总条数为必要参数
      this.findByPage(curpage, pagesize, $callback)
    },
    findByPage(currentPage, pageSize, $callback) {
      let $this = this
      post(
        'http://localhost:30033/core-api/eco/sample/v1/pagination/findPaginationPage/' +
          currentPage + '/' + pageSize, this.params
      ).then(data => {
        let result = data.data
        if (result) {
          this.moduleTableData = result.items
          $callback(result.totalPage, result.totalRows, result.currentPage)
        }
      })
    }
  },
  mounted() {
    this.init()
  }
}
</script>
````

### 4.3效果图

![image-20191227103600302](/Users/litian/Library/Application Support/typora-user-images/image-20191227103600302.png)

### 4.4注意

在调用分页API`queryForMapPage`方法的时候sql语句一定要传入参数，同时返回的分页要做pageSize是否为0的判断并处理，如下：

![image-20191230160250698](/Users/litian/Library/Application Support/typora-user-images/image-20191230160250698.png)

## 5.附录

### 5.1PageParam源码

```java
public class PageParam {
    private long pageNumber;
    private long pageSize;

    public static PageParam create() {
        return create(1L, 10L);
    }

    public static PageParam create(long pageNumber, long pageSize) {
        return new PageParam(pageNumber, pageSize);
    }

    public PageParam(long pageNumber, long pageSize) {
        if (pageNumber < 1L) {
            this.pageNumber = 1L;
        }

        this.pageNumber = pageNumber < 1L ? 1L : pageNumber;
        this.pageSize = pageSize <= 0L ? 10L : pageSize;
    }

    public PageParam next() {
        return create(this.getPageNumber() + 1L, this.getPageSize());
    }

    public PageParam previous() {
        return this.getPageNumber() == 1L ? this : create(this.getPageNumber() - 1L, this.getPageSize());
    }

    public PageParam first() {
        return this.getPageNumber() == 1L ? this : create(1L, this.getPageSize());
    }

    public long getPageSize() {
        return this.pageSize;
    }

    public long getPageNumber() {
        return this.pageNumber;
    }

    public long getOffset() {
        return (this.pageNumber - 1L) * this.pageSize;
    }

    public boolean hasPrevious() {
        return this.pageNumber > 1L;
    }

    public PageParam previousOrFirst() {
        return this.hasPrevious() ? this.previous() : this.first();
    }
}
```

### 5.2Page源码

```java
@ApiModel("分页数据")
public class Page<T> implements Serializable {
    private static final long serialVersionUID = -2688096525186695400L;
    public static final int DEFAULT_DATA_SIZE_IN_ONE_PAGE = 10;
    public static final int DEFAULT_PAGE_NUMBER = 1;
    private long pageSize;
    private long currentPage;
    private List<T> items;
    private long totalRows;
    private long totalPage;

    public Page() {
        this(Collections.EMPTY_LIST, 0L, 1L, 10L);
    }

    public Page(List<T> data, long totalCount, long currentPage, long pageSize) {
        this.pageSize = 10L;
        this.pageSize = pageSize;
        this.currentPage = currentPage;
        this.totalRows = totalCount;
        this.items = data;
    }

    public long getTotalRows() {
        return this.totalRows;
    }

    public long getTotalPage() {
        if (this.totalRows % this.pageSize == 0L) {
            this.totalPage = this.totalRows / this.pageSize;
        } else {
            this.totalPage = this.totalRows / this.pageSize + 1L;
        }

        return this.totalPage;
    }

    @JsonIgnore
    public int getDataSize() {
        return null == this.items ? 0 : this.items.size();
    }

    public Stream<T> stream() {
        return null == this.items ? Stream.empty() : this.items.stream();
    }

    public void setTotalPage(long totalPage) {
        this.totalPage = totalPage;
    }

    public long getPageSize() {
        return this.pageSize;
    }

    public List<T> getItems() {
        return this.items;
    }

    public long getCurrentPage() {
        return this.currentPage;
    }

    @JsonIgnore
    public boolean hasNext() {
        return this.getCurrentPage() < this.getTotalPage();
    }

    @JsonIgnore
    public boolean hasPrevious() {
        return this.getCurrentPage() > 1L;
    }

    @JsonIgnore
    public boolean hasContent() {
        return null != this.items && this.items.size() > 0;
    }

    @JsonIgnore
    public boolean isFirst() {
        return !this.hasPrevious();
    }

    @JsonIgnore
    public boolean isLast() {
        return !this.hasNext();
    }

    public static int getStartOfPage(int pageNo) {
        return getStartOfPage(pageNo, 10);
    }

    public static int getStartOfPage(int pageNo, int pageSize) {
        if (pageSize <= 0) {
            throw new IllegalArgumentException("页面索引不能小于1!");
        } else {
            return (pageNo - 1) * pageSize;
        }
    }

    public void setPageSize(int pageSize) {
        this.pageSize = (long)pageSize;
    }

    public void setCurrentPage(long currentPage) {
        this.currentPage = currentPage;
    }

    public void setItems(List<T> items) {
        this.items = items;
    }

    public void setTotalRows(long totalRows) {
        this.totalRows = totalRows;
    }

    public String toString() {
        return String.format("Page{dataSize%d,pageSize=%d, currentPage=%d, totalRows=%d, totalPage=%d}", null == this.items ? 0 : this.items.size(), this.pageSize, this.currentPage, this.totalRows, this.totalPage);
    }
}
```

## 6.Utils工具类

### 6.1组件介绍

组件提供了一些常用的工具类，包括分页的实体对象Page，一些常量的定义以及统一的异常类等等。

### 6.2组件整体设计

<img src="/Users/litian/Library/Application Support/typora-user-images/image-20191230151620603.png" alt="image-20191230151620603" style="zoom:50%;" />

### 6.3组件功能说明

#### 6.3.1distributeld

| 类           | 说明                           |
| ------------ | ------------------------------ |
| UidGenerator | 提供分布式主键生成策略抽象接口 |

#### 6.3.2enums

| 类          | 说明               |
| ----------- | ------------------ |
| LogicSymbol | 提供逻辑符号枚举类 |

#### 6.3.3exception

| 类                     | 说明           |
| ---------------------- | -------------- |
| AbstractCoderException | 统一异常抽象类 |
| BusinessException      | 业务异常类     |
| ErrorCode              | 错误代码接口   |
| InternalException      | 内部异常类     |

#### 6.3.4其他

| 类              | 说明             |
| --------------- | ---------------- |
| ApiResult       | 统一异常抽象类   |
| BasePageRequest | 分页访问上层对象 |
| JsonResponse    | Json响应数据类   |
| Page<T>         | 分页数据类       |
| TreeNode<T>     | 树节点类         |
| DictItem        | 字典对象         |
| ....            | ...              |